<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório Financeiro - Análise v4</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --ink:#e5e7eb;
      --ink-dim:#94a3b8;
      --accent:#22c55e;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --negative:#fecaca;
      --positive:#bbf7d0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 20% -10%, #172554 0%, transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, #052e16 0%, transparent 60%), var(--bg);
    }
    header{
      padding:28px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#22c55e 0%,#0ea5e9 60%,#a78bfa 100%);box-shadow:var(--shadow);}
    h1{font-size:22px;margin:0;font-weight:800}
    .subtitle{color:var(--ink-dim);font-size:13px;margin-top:2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{background:linear-gradient(180deg,#1f2937,#111827);color:var(--ink);border:1px solid #334155;padding:10px 14px;border-radius:12px;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s ease;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    button:hover,.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:#475569}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#16a34a;color:#03180d}
    .btn-warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#d97706;color:#1a0f00}
    .btn-ghost{background:transparent;border-color:transparent;color:#60a5fa;padding:6px 8px;border-radius:8px}
    .btn-ghost:hover{background:#1e293b;transform:none;box-shadow:none}
    .btn-sm{padding:6px 10px;font-size:12px;border-radius:10px}
    .btn-link{background:none;border:none;color:#60a5fa;font-weight:600;padding:0;cursor:pointer}
    .btn-link:hover{text-decoration:underline;transform:none;box-shadow:none}
    .container{padding:0 22px 80px}
    .grid{display:grid;gap:16px}
    .grid.auto-fit{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),var(--panel);border:1px solid #233045;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;position:relative}
    .card.card-empty{opacity:.7}
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .card-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .kpi{padding:18px;background:linear-gradient(180deg,rgba(34,197,94,.09),rgba(34,197,94,.03)),#0b1324;border:1px solid rgba(34,197,94,.25);border-radius:16px;display:flex;flex-direction:column;gap:6px}
    .kpi.alt{background:linear-gradient(180deg,rgba(96,165,250,.08),rgba(96,165,250,.03)),#0b1324;border-color:rgba(96,165,250,.35)}
    .kpi.warn{background:linear-gradient(180deg,rgba(245,158,11,.10),rgba(245,158,11,.03)),#0b1324;border-color:rgba(245,158,11,.35)}
    .kpi .label{color:#99f6e4;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
    .kpi .value{font-size:26px;font-weight:800}
    .kpi .desc{color:var(--ink-dim);font-size:12px}
    .hero{border-radius:20px;padding:20px 18px;margin-bottom:18px;background:radial-gradient(800px 300px at 20% -10%,rgba(34,197,94,.18),transparent 60%),linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),#0b1324;border:1px solid #1e293b;box-shadow:var(--shadow)}
    .divider{height:1px;background:#1f2a3c;margin:14px 0}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3546;background:#0a1322;border-radius:999px;font-size:12px;color:#cbd5e1;margin-right:8px;margin-bottom:6px}
    .search-bar{margin-top:16px;display:flex;justify-content:flex-end}
    .search-bar input{width:320px;max-width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1f2a3c;background:#0b1324;color:var(--ink);font-size:13px}
    .search-bar input::placeholder{color:#475569}
    .tabs{display:flex;gap:8px;margin:6px 0 14px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #334155;background:#0b1324;color:#cbd5e1;font-weight:600;font-size:12px;cursor:pointer}
    .tab.active{border-color:#60a5fa;background:linear-gradient(180deg,rgba(59,130,246,.18),rgba(59,130,246,.06));color:#e2e8f0}
    .table-host{overflow-x:auto}
    .table-host table{min-width:640px}
    .table-host table th,.table-host table td{white-space:normal;word-break:break-word}
    .btn-group{display:inline-flex;gap:6px;padding:4px;background:#0b1324;border-radius:999px;border:1px solid #1f2a3c}
    .btn-group .toggle{background:transparent;border:1px solid #1f2a3c;color:#cbd5e1;font-weight:600;font-size:12px;padding:6px 12px;border-radius:999px;cursor:pointer}
    .btn-group .toggle.active{border-color:#60a5fa;background:linear-gradient(180deg,rgba(59,130,246,.18),rgba(59,130,246,.06));color:#e2e8f0}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{color:#9ca3af;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;text-align:left;padding:8px}
    tbody td{padding:10px 8px;background:#0a1220;border-top:1px solid #20314a;border-bottom:1px solid #20314a}
    tbody tr{transition:transform .2s ease,background .2s ease}
    tbody tr:hover{transform:translateY(-1px);background:rgba(148,163,184,.08)}
    tbody td:first-child{border-left:1px solid #20314a;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid #20314a;border-top-right-radius:12px;border-bottom-right-radius:12px;text-align:right}
    tbody tr.row-active{background:rgba(96,165,250,.18)}
    tbody tr.row-highlight{background:rgba(34,197,94,.14)}
    .muted{color:var(--ink-dim)}
    .small{font-size:12px}
    .hidden{display:none}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;background:#0a162b;border:1px solid #22324f;color:#e2e8f0}
    .pill.negative{background:#2a0a10;border-color:#4c1d1d;color:var(--negative)}
    .pill.positive{background:#062a17;border-color:#064e3b;color:var(--positive)}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;border:1px solid #334155;background:#152039;color:#cbd5e1}
    .badge.error{border-color:#b91c1c;background:#451313;color:#fecaca}
    .badge.warn{border-color:#d97706;background:#3f2205;color:#facc15}
    .badge.ok{border-color:#16a34a;background:#052b19;color:#bbf7d0}
    .filter-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:#0b1324;border:1px solid #1f2a3c;font-size:12px}
    .chip button{background:none;border:none;color:#60a5fa;font-weight:700;cursor:pointer}
    .validation-list{display:flex;flex-direction:column;gap:10px}
    .validation-row{display:flex;flex-direction:column;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid #1f2a3c;background:#0a1320}
    .validation-row .header{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:13px}
    .validation-row .header-left{display:flex;align-items:center;gap:8px;font-weight:600}
    .validation-row.ok{border-color:#14532d}
    .validation-row.warn{border-color:#b45309}
    .validation-row.error{border-color:#7f1d1d}
    .validation-row details{font-family:monospace;font-size:11px;background:#050a17;border-radius:8px;padding:8px}
    .validation-row details summary{cursor:pointer;font-size:11px;font-weight:600;color:#60a5fa}
    .bar-cell{display:flex;align-items:center;gap:8px;justify-content:flex-end}
    .bar-cell .bar-wrapper{flex:0 0 120px;background:#1e293b;border-radius:999px;overflow:hidden;height:6px}
    .bar-cell .bar{height:100%;background:linear-gradient(90deg,#22d3ee,#2563eb)}
    .status-note{font-size:12px;color:#eab308}
    #toast{position:fixed;bottom:18px;right:18px;background:#111827;border:1px solid #334155;padding:12px 14px;border-radius:10px;color:#e2e8f0;box-shadow:var(--shadow);display:none;max-width:400px;z-index:9999}
    #toast.error{border-color:#dc2626;background:#1f0808}
    #toast.success{border-color:#22c55e;background:#062a17}
    #loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999}
    #loading.show{display:flex}
    .spinner{width:60px;height:60px;border:4px solid #334155;border-top-color:#22c55e;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .alert{padding:16px;border-radius:12px;margin:16px 0;border:1px solid}
    .alert.error{background:#2a0a10;border-color:#4c1d1d;color:#fecaca}
    .alert.info{background:#0a1b2e;border-color:#1e3a5f;color:#93c5fd}
    .alert.success{background:#062a17;border-color:#064e3b;color:#bbf7d0}
    .card .empty-message{color:var(--ink-dim);font-size:12px;padding:8px 4px}
    @media print{
      body{background:#fff;color:#000}
      header,.toolbar,button,.btn,#toast,#loading{display:none!important}
      .hero,.card{box-shadow:none;border:1px solid #ccc;background:#fff;color:#000}
      .card{page-break-inside:avoid}
      .tabs,.tab{display:none!important}
      .hidden{display:block!important}
      .chip button{display:none}
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="loading"><div class="spinner"></div></div>

  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Relatório Financeiro — Análise v4</h1>
        <div class="subtitle">Aguardando carregamento da planilha...</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btn-refresh">🔄 Recarregar</button>
      <label class="btn">
        <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none">
        📁 Selecionar Arquivo
      </label>
      <button class="btn" id="btn-picker">📂 Seletor do Sistema</button>
      <button class="btn btn-warn" id="btn-test">🔍 Testar Planilha</button>
      <button class="btn" onclick="window.print()">🖨️ Imprimir</button>
    </div>
  </header>

  <main class="container">
    <!--
    Relatório Financeiro - Análise v4.0
    Características:
    - Visão única consolidada por complexidade × volume
    - DRE Simplificada com margem líquida
    - Pró-labores separados do resultado operacional
    -->
    <div id="status-area"></div>

    <section class="hero">
      <h2>Visão Executiva</h2>
      <p class="muted">Principais resultados e impactos — tickets, custos alocados e resultado por regime.</p>
      <div class="grid auto-fit">
        <div class="kpi" id="kpi-receita-mensal">
          <div class="label">Receita Mensal Total</div>
          <div class="value">—</div>
          <div class="desc"><span id="kpi-qtd-clientes" class="pill">— clientes</span></div>
        </div>
        <div class="kpi alt" id="kpi-ticket-medio">
          <div class="label">Ticket Médio Mensal</div>
          <div class="value">—</div>
          <div class="desc">Valor médio por cliente</div>
        </div>
        <div class="kpi" id="kpi-custo-medio">
          <div class="label">Custo Médio Mensal (cliente)</div>
          <div class="value">—</div>
          <div class="desc">Baseado em custos alocados</div>
        </div>
        <div class="kpi" id="kpi-resultado-medio">
          <div class="label">Resultado Médio Mensal (cliente)</div>
          <div class="value">—</div>
          <div class="desc">Após custos alocados</div>
        </div>
        <div class="kpi warn" id="kpi-resultado-total">
          <div class="label">Resultado Total</div>
          <div class="value">—</div>
          <div class="desc"><span id="kpi-margem-resultado" class="pill">—</span></div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="tag">Alfa (volume): <strong id="meta-alfa">—</strong></div>
      <div class="tag">Beta (ticket): <strong id="meta-beta">—</strong></div>
      <div class="search-bar">
        <input type="search" id="global-search" placeholder="Buscar por regime, segmento ou cliente...">
      </div>
    </section>

    <section class="card" id="card-resultado">
      <div class="card-header">
        <h2 style="margin:0">Resultado Operacional</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="Resultado_Regime_Com_Peso">Sem dados</span>
          <span class="badge warn hidden" data-status-sheet="Resultado_Segmento_Com_Peso">Sem dados</span>
          <div class="btn-group" role="group" aria-label="Alternar visão do resultado">
            <button class="btn-sm toggle active" data-resultado-view="regime">Por Regime</button>
            <button class="btn-sm toggle" data-resultado-view="regimeAtividade">Regime + Atividade</button>
          </div>
          <button class="btn-sm" data-export="tabResultado">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div class="filter-chips" id="chip-segmento"></div>
      <div id="tabResultado" class="table-host"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="card-header">
        <h2 style="margin:0">ROI por Regime</h2>
        <div class="card-actions">
          <button class="btn-sm" data-export="tabROI">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div id="tabROI" class="table-host"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="card-header">
        <h2 style="margin:0">Top 20 Clientes Contribuintes (Curva ABC)</h2>
        <div class="card-actions">
          <button class="btn-sm" data-export="tabTopClientes">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div id="tabTopClientes" class="table-host"></div>
    </section>

    <section class="card" style="margin-top:16px" id="card-tickets">
        <div class="card-header">
          <h2 style="margin:0">Tickets Médios</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="Ticket_Regime">Sem dados</span>
          <span class="badge warn hidden" data-status-sheet="Ticket_Regime_Atividade">Sem dados</span>
          <span class="badge warn hidden" data-status-sheet="Ticket_Clientes">Sem dados</span>
          <button class="btn-sm" data-export="tabTickets">⬇️ Exportar CSV</button>
        </div>
        </div>
        <div class="tabs">
          <button class="tab active" data-ticket-view="regime">Por Regime</button>
          <button class="tab" data-ticket-view="regimeAtividade">Regime + Atividade</button>
          <button class="tab" data-ticket-view="clientes">Top Clientes</button>
        </div>
        <div class="filter-chips" id="chip-tickets"></div>
        <div id="tabTickets" class="table-host"></div>
    </section>

    <section class="card" style="margin-top:16px" id="card-top-desp">
      <div class="card-header">
        <h2 style="margin:0">Top Despesas (Geral)</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="Top_Despesas">Sem dados</span>
          <button class="btn-sm" data-export="tabTopDespesas">⬇️ Exportar CSV</button>
          <button class="btn-ghost" data-excel="Top_Despesas">Ver no Excel</button>
        </div>
      </div>
      <div id="tabTopDespesas" class="table-host"></div>
    </section>

    <section class="card" style="margin-top:16px" id="card-dre">
      <div class="card-header">
        <h2 style="margin:0">DRE Simplificada</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="DRE_Simplificada">Sem dados</span>
          <button class="btn-sm" data-export="tabDRE">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div id="tabDRE" class="table-host"></div>
    </section>

    <section class="card" style="margin-top:16px" id="card-margem">
      <div class="card-header">
        <h2 style="margin:0">Margem de Contribuição</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="DRE_Margem_Contribuicao">Sem dados</span>
          <button class="btn-sm" data-export="cardMargem">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div class="grid auto-fit" id="margem-cards">
        <div class="kpi" id="margem-total">
          <div class="label">Valor Total</div>
          <div class="value">—</div>
          <div class="desc">Margem acumulada</div>
        </div>
        <div class="kpi alt" id="margem-mensal">
          <div class="label">Valor Mensal</div>
          <div class="value">—</div>
          <div class="desc">Base nos últimos 10 meses</div>
        </div>
        <div class="kpi" id="margem-cliente">
          <div class="label">Valor por Cliente (mensal)</div>
          <div class="value">—</div>
          <div class="desc"><span id="margem-clientes-total" class="pill">— clientes</span></div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px" id="card-validacoes">
      <div class="card-header">
        <h2 style="margin:0">Validações & Confrontos</h2>
      </div>
      <div class="validation-list" id="validations-list"></div>
    </section>

  </main>
  <div id="toast"></div>

  <script>
    // ---------- Normalização e utilidades ----------
    function normalizeKey(k){
      return String(k||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toLowerCase().trim().replace(/\s+/g,'_')
        .replace(/[^\w_]/g,'');
    }
    function rowToMap(row){
      const m={}; Object.keys(row||{}).forEach(k=> m[normalizeKey(k)]=row[k]); return m;
    }
    function asNum(v){
      if(v===null||v===undefined) return 0;
      if(typeof v==='number' && Number.isFinite(v)) return v;
      if(typeof v==='string'){
        const s=v.replace(/[^\d,\.\-]/g,'').replace(/\./g,'').replace(',','.');
        const n=parseFloat(s); return Number.isFinite(n)?n:0;
      }
      const n=Number(v); return Number.isFinite(n)?n:0;
    }
    function pct01(x){
      const n = asNum(x);
      if (!Number.isFinite(n)) return 0;
      return n>1 ? n/100 : n;
    }
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const PCT = new Intl.NumberFormat('pt-BR',{style:'percent', minimumFractionDigits:1, maximumFractionDigits:1});
    const DEC = new Intl.NumberFormat('pt-BR',{maximumFractionDigits:2});
    const INT = new Intl.NumberFormat('pt-BR',{maximumFractionDigits:0});

    const SHEET_ALIASES = {
      'Ticket_Geral':['Ticket_Geral'],
      'Ticket_Regime':['Ticket_Regime','Ticket_Reg'],
      'Ticket_Regime_Atividade':['Ticket_Regime_Atividade','Ticket_Reg_Atividade'],
      'Ticket_Clientes':['Ticket_Clientes'],
      'Resultado_Regime_Com_Peso':['Resultado_Regime_Com_Peso','Res_Regime_Com_Peso'],
      'Resultado_Segmento_Com_Peso':['Resultado_Segmento_Com_Peso','Res_Segmento_Com_Peso'],
      'Resumo_Retirada':['Resumo_Retirada'],
      'Top_Despesas':['Top_Despesas'],
      'DRE_Simplificada':['DRE_Simplificada','DRE_Simples'],
      'DRE_Margem_Contribuicao':['DRE_Margem_Contribuicao','DRE_Margem_Contrib']
    };

    const canonicalSheetName = (name)=>{
      if(!name && name!==0) return '';
      const lower = String(name).toLowerCase();
      for(const [canonical, aliases] of Object.entries(SHEET_ALIASES)){
        if(canonical.toLowerCase()===lower) return canonical;
        if((aliases||[]).some(alias=>String(alias).toLowerCase()===lower)) return canonical;
      }
      return String(name);
    };

    const sheetCandidateNames = (name)=>{
      const canonical = canonicalSheetName(name);
      const aliases = SHEET_ALIASES[canonical] || [];
      const candidates = [canonical, ...aliases];
      return Array.from(new Set(candidates.map(n=>String(n))));
    };

    const findSheetName = (wb, name)=>{
      if(!wb || !Array.isArray(wb.SheetNames)) return null;
      const sheets = wb.SheetNames.map(raw=>({raw, lower:String(raw).toLowerCase()}));
      for(const candidate of sheetCandidateNames(name)){
        const lower = String(candidate).toLowerCase();
        const found = sheets.find(entry=>entry.lower===lower);
        if(found) return found.raw;
      }
      return null;
    };

    const hasSheet = (wb, name)=> !!findSheetName(wb, name);

    const sum = (rows, getter) => (rows||[]).reduce((a,r)=> a + asNum(getter(r)), 0);

    // ---------- Metadados de schema ----------
    let schemas = {};

    function buildSchemas(wb){
      const result = {};
      (wb.SheetNames||[]).forEach(name=>{
        if(!name.startsWith('_metadata_')) return;
        const base = name.replace(/^_metadata_/, '');
        const canonical = canonicalSheetName(base);
        const sheet = wb.Sheets[name];
        if(!sheet) return;
        const rows = XLSX.utils.sheet_to_json(sheet) || [];
        const lookup = {};
        rows.forEach(entry=>{
          const campo = entry.campo ?? entry.Campo ?? entry.CAMPO;
          if(!campo) return;
          const norm = normalizeKey(campo);
          lookup[norm] = {
            campo,
            tipo: entry.tipo ?? entry.Tipo ?? entry.TIPO ?? '',
            descricao: entry.descricao ?? entry.Descricao ?? entry.DESCRICAO ?? ''
          };
        });
        result[canonical] = { rows, lookup };
      });
      return result;
    }

    function getSchemaKey(sheetName, field){
      const schema = schemas[canonicalSheetName(sheetName)];
      if(!schema) return normalizeKey(field);
      const entry = schema.lookup[normalizeKey(field)];
      return entry ? normalizeKey(entry.campo) : normalizeKey(field);
    }

    function pick(row, field, sheetName){
      const map = rowToMap(row);
      const key = getSchemaKey(sheetName, field);
      if(key in map) return map[key];
      const alt = normalizeKey(field);
      return map[alt];
    }

    function sheetRows(wb, name){
      const actual = findSheetName(wb, name);
      if(!actual) return null;
      const sh = wb.Sheets[actual];
      if(!sh) return null;
      const rows = XLSX.utils.sheet_to_json(sh);
      return rows.map(rowToMap);
    }

    function getSheets(wb){
      return {
        g: sheetRows(wb,'Ticket_Geral')||[],
        tr: sheetRows(wb,'Ticket_Regime')||[],
        tra: sheetRows(wb,'Ticket_Regime_Atividade')||[],
        tc: sheetRows(wb,'Ticket_Clientes')||[],
        rc: sheetRows(wb,'Resultado_Regime_Com_Peso')||[],
        segc: sheetRows(wb,'Resultado_Segmento_Com_Peso')||[],
        td: sheetRows(wb,'Top_Despesas')||[],
        rr: sheetRows(wb,'Resumo_Retirada')||[],
        dre: sheetRows(wb,'DRE_Simplificada')||[],
        mc: sheetRows(wb,'DRE_Margem_Contribuicao')||[]
      };
    }

    function computeKPIs(S){
      const g0 = S.g[0] || {};
      let receitaMensal = asNum(pick(g0,'receita_mensal','Ticket_Geral'));
      if(!receitaMensal){
        receitaMensal = sum(S.rc, r=> pick(r,'receita_mensal','Resultado_Regime_Com_Peso')) || 0;
      }

      let clientes = sum(S.tr, r=> pick(r,'qtd_clientes','Ticket_Regime'));
      if(!clientes){
        const uniq = new Set(S.tc.map(r=> pick(r,'cliente','Ticket_Clientes')).filter(Boolean));
        clientes = uniq.size || 0;
      }

      let ticketMedio = asNum(pick(g0,'ticket_medio_mensal','Ticket_Geral'));
      if(!ticketMedio && receitaMensal && clientes) ticketMedio = receitaMensal / clientes;

      let receitaAlocada = sum(S.rc, r=> pick(r,'receita_mensal','Resultado_Regime_Com_Peso'));
      if(!receitaAlocada){
        receitaAlocada = sum(S.segc, r=> pick(r,'receita_mensal','Resultado_Segmento_Com_Peso'));
      }
      if(!receitaAlocada){
        receitaAlocada = receitaMensal;
      }
      let custoAlocado   = sum(S.rc, r=> pick(r,'custo_mensal','Resultado_Regime_Com_Peso'));
      if(!custoAlocado){
        custoAlocado = sum(S.segc, r=> pick(r,'custo_mensal','Resultado_Segmento_Com_Peso'));
      }
      let resultadoTotal     = sum(S.rc, r=> pick(r,'resultado_mensal','Resultado_Regime_Com_Peso'));
      if(!resultadoTotal){
        resultadoTotal = sum(S.segc, r=> pick(r,'resultado_mensal','Resultado_Segmento_Com_Peso'));
      }
      if(!resultadoTotal && receitaAlocada && custoAlocado) resultadoTotal = receitaAlocada - custoAlocado;

      const custoMedio = clientes ? (custoAlocado||0)/clientes : 0;
      const resultadoMedio = clientes ? (resultadoTotal||0)/clientes : 0;

      return { receitaMensal, clientes, ticketMedio, custoMedio, resultadoMedio, resultadoTotal, receitaAlocada };
    }

    function fillKPIs(k){
      document.querySelector('#kpi-receita-mensal .value').textContent = BRL.format(k.receitaMensal||0);
      document.querySelector('#kpi-ticket-medio .value').textContent   = BRL.format(k.ticketMedio||0);
      document.querySelector('#kpi-qtd-clientes').textContent          = `${INT.format(k.clientes||0)} clientes`;

      document.querySelector('#kpi-custo-medio .value').textContent    = BRL.format(k.custoMedio||0);
      document.querySelector('#kpi-resultado-medio .value').textContent = BRL.format(k.resultadoMedio||0);

      const mB = k.receitaAlocada ? (k.resultadoTotal||0)/k.receitaAlocada : 0;

      const kpiRes=document.getElementById('kpi-resultado-total');
      kpiRes.querySelector('.label').textContent = 'Resultado Total';
      kpiRes.querySelector('.value').textContent = BRL.format(k.resultadoTotal||0);
      const tagB = document.getElementById('kpi-margem-resultado');
      tagB.textContent = PCT.format(mB);
      tagB.classList.toggle('positive', mB>=0);
      tagB.classList.toggle('negative', mB<0);
    }

    function rowsResultadoRegime(rows, sheet){
      const clientesByReg = Object.fromEntries(
        (window._S?.tr||[]).map(r=>[ String(pick(r,'regime','Ticket_Regime')||'').toLowerCase(), asNum(pick(r,'clientes','Ticket_Regime')) ])
      );

      return (rows||[]).map(r=>{
        const regime = String(pick(r,'regime_base',sheet)||'').trim();
        const rec = asNum(pick(r,'receita_mensal',sheet));
        const cus = asNum(pick(r,'custo_mensal',sheet));
        let res = asNum(pick(r,'resultado_mensal',sheet));
        if(!res && (rec||cus)) res = rec - cus;
        let cli = asNum(pick(r,'qtd_clientes',sheet));
        if(!cli) cli = clientesByReg[regime.toLowerCase()]||0;
        let ticket = asNum(pick(r,'ticket_medio_mensal',sheet));
        if(!ticket && cli) ticket = cli ? rec/cli : 0;
        let custoMedio = asNum(pick(r,'custo_medio_mensal',sheet));
        if(!custoMedio && cli) custoMedio = cli ? cus/cli : 0;
        let resultadoMedio = asNum(pick(r,'resultado_medio_mensal',sheet));
        if(!resultadoMedio && cli) resultadoMedio = cli ? res/cli : 0;
        return {
          regime,
          clientes:cli,
          receita:rec,
          custo:cus,
          resultado:res,
          ticketMedio: ticket,
          custoMedio,
          resultadoMedio,
          margem: rec? res/rec:0
        };
      });
    }

    function rowsResultadoSegmento(rows){
      return (rows||[]).map(r=>{
        const regime = pick(r,'regime_base','Resultado_Segmento_Com_Peso')||'';
        const seg = pick(r,'atividade','Resultado_Segmento_Com_Peso')||'';
        const cli = asNum(pick(r,'qtd_clientes','Resultado_Segmento_Com_Peso'));
        const rec = asNum(pick(r,'receita_mensal','Resultado_Segmento_Com_Peso'));
        const cus = asNum(pick(r,'custo_mensal','Resultado_Segmento_Com_Peso'));
        let res  = asNum(pick(r,'resultado_mensal','Resultado_Segmento_Com_Peso'));
        if(!res && (rec||cus)) res = rec - cus;
        let custoMedio = asNum(pick(r,'custo_medio_mensal','Resultado_Segmento_Com_Peso'));
        if(!custoMedio && cli) custoMedio = cli? cus/cli:0;
        let resultadoMedio = asNum(pick(r,'resultado_medio_mensal','Resultado_Segmento_Com_Peso'));
        if(!resultadoMedio && cli) resultadoMedio = cli? res/cli:0;
        let ticket = asNum(pick(r,'ticket_medio_mensal','Resultado_Segmento_Com_Peso'));
        if(!ticket && cli) ticket = cli? rec/cli:0;
        return {
          regime,
          atividade:seg,
          clientes:cli,
          receita:rec,
          custo:cus,
          resultado:res,
          custoMedio,
          resultadoMedio,
          ticketMedio: ticket
        };
      });
    }

    function rowsTicketRegime(rows){
      return (rows||[]).map(r=>{
        const regime = pick(r,'regime','Ticket_Regime')||'';
        const cli = asNum(pick(r,'clientes','Ticket_Regime'));
        let rec = asNum(pick(r,'receita','Ticket_Regime'));
        if(!rec){
          const byReg = Object.fromEntries((window._S?.rc||[]).map(x=>[ String(pick(x,'regime_base','Resultado_Regime_Com_Peso')||'').toLowerCase(), asNum(pick(x,'receita_mensal','Resultado_Regime_Com_Peso')) ]));
          rec = byReg[String(regime||'').toLowerCase()]||0;
        }
        let ticket = asNum(pick(r,'ticketMedio','Ticket_Regime'));
        if(!ticket && (rec||cli)) ticket = cli? rec/cli:0;
        return {regime, clientes:cli, receita:rec, ticketMedio:ticket};
      });
    }

    function rowsTicketRegimeAtividade(rows){
      return (rows||[]).map(r=>{
        const regime = pick(r,'regime','Ticket_Regime_Atividade')||'';
        const atividade = pick(r,'atividade','Ticket_Regime_Atividade')||'';
        const clientes = asNum(pick(r,'clientes','Ticket_Regime_Atividade'));
        const receita = asNum(pick(r,'receita','Ticket_Regime_Atividade'));
        let ticket = asNum(pick(r,'ticketMedio','Ticket_Regime_Atividade'));
        if(!ticket && clientes) ticket = clientes? receita/clientes:0;
        return {regime, atividade, clientes, receita, ticketMedio:ticket};
      });
    }

    function rowsTicketClientes(rows){
      return (rows||[]).map(r=>({
        rank: asNum(pick(r,'rank','Ticket_Clientes')) || asNum(r.rank) || 0,
        cliente: pick(r,'cliente','Ticket_Clientes')||'',
        regime: pick(r,'regime','Ticket_Clientes')||'',
        atividade: pick(r,'atividade','Ticket_Clientes')||'',
        receita_mensal: asNum(pick(r,'receita_mensal','Ticket_Clientes')),
        ticket: asNum(pick(r,'ticket_mensal','Ticket_Clientes'))
      }));
    }

    function rowsTopDespesas(rows){
      const mapped = (rows||[]).map((r,i)=>{
        const valor = asNum(pick(r,'valor','Top_Despesas'));
        return {
          rank: asNum(pick(r,'rank','Top_Despesas')) || i+1,
          grupo: pick(r,'grupo','Top_Despesas') || '',
          item_nome: pick(r,'item_nome','Top_Despesas') || '',
          valor
        };
      });
      const tot = sum(mapped, r=> r.valor);
      let acc = 0;
      return mapped.map((r,i)=>{
        const valor = asNum(r.valor);
        const p = tot? (valor/tot):0;
        acc += p;
        return {
          rank: r.rank || i+1,
          grupo: r.grupo,
          item_nome: r.item_nome,
          valor,
          perc_total_despesas: p,
          perc_acumulado: acc
        };
      });
    }

    function rowsMargemContribuicao(rows){
      return (rows||[]).map(r=>({
        margem_total: asNum(pick(r,'margem_total','DRE_Margem_Contribuicao')),
        margem_mensal: asNum(pick(r,'margem_mensal','DRE_Margem_Contribuicao')),
        clientes_total: asNum(pick(r,'clientes_total','DRE_Margem_Contribuicao')),
        margem_por_cliente: asNum(pick(r,'margem_por_cliente','DRE_Margem_Contribuicao'))
      }));
    }

    const state = {
      wb:null,
      datasets:{},
      filters:{segmentRegime:null,ticketRegime:null},
      searchTerm:'',
      sheetStatus:{missingOptional:[]},
      resultadoView:'regime',
      ticketView:'regime'
    };

    const TABLE_CACHE = {};

  const REQUIRED_SHEETS = [
    'Ticket_Geral',
    'Resultado_Regime_Com_Peso',
    'Resumo_Retirada',
    'DRE_Simplificada'
  ];

    const OPTIONAL_SHEETS = [
      'Ticket_Regime',
      'Ticket_Regime_Atividade',
      'Ticket_Clientes',
      'Resultado_Segmento_Com_Peso',
      'Top_Despesas',
      'DRE_Margem_Contribuicao'
    ];

    const showLoading = (show)=>{
      document.getElementById('loading').classList.toggle('show', show);
    };

    const showToast = (msg, type='info')=>{
      const t=document.getElementById('toast');
      t.textContent=msg;
      t.className=type;
      t.style.display='block';
      clearTimeout(showToast._timer);
      showToast._timer=setTimeout(()=>t.style.display='none',5000);
    };

    const showStatus = (msg, type='info')=>{
      const area=document.getElementById('status-area');
      area.innerHTML=`<div class="alert ${type}">${msg}</div>`;
    };

    const percentDiff = (expected, observed)=>{
      const exp=asNum(expected);
      const obs=asNum(observed);
      const denom = Math.abs(exp) > 1e-6 ? Math.abs(exp) : Math.abs(obs) || 1;
      return (obs-exp)/denom;
    };

    function registerTableData(targetId, columns, rows, metaSheet=null){
      TABLE_CACHE[targetId]={columns,rows,metaSheet};
    }

    function tableFromData(targetId, columns, rows, options={}){
      const root=document.getElementById(targetId);
      if(!root) return;
      if(!rows||!rows.length){
        root.innerHTML='<div class="empty-message">Sem dados disponíveis.</div>';
        registerTableData(targetId, columns, [], options.metaSheet||null);
        return;
      }
      const head=columns.map(c=>`<th${c.right?' style="text-align:right"':''}>${c.label||c.key}</th>`).join('');
      const body=rows.map((r,idx)=>{
        return '<tr>'+columns.map(c=>{
          let val=r[c.key];
          if(c.format) val=c.format(val,r,idx);
          return `<td${c.right?' style="text-align:right"':''}>${val??''}</td>`;
        }).join('')+'</tr>';
      }).join('');
      root.innerHTML=`<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
      registerTableData(targetId, columns, rows, options.metaSheet||null);
      const trs=root.querySelectorAll('tbody tr');
      trs.forEach((tr,idx)=>{
        if(options.getRowClass){
          const cls=options.getRowClass(rows[idx]);
          if(cls) tr.classList.add(cls);
        }
        if(options.onRowClick){
          tr.style.cursor='pointer';
          tr.addEventListener('click',()=>options.onRowClick(rows[idx]));
        }
      });
    }

    const tryGetSheet = (wb,name)=>{
      const actual = findSheetName(wb, name) || (wb && wb.Sheets && wb.Sheets[name] ? name : null);
      if(!actual) return null;
      try{
        return XLSX.utils.sheet_to_json(wb.Sheets[actual]);
      }catch(e){
        console.error(`Erro ao ler aba ${actual}:`,e);
        return null;
      }
    };

    async function fetchRelativeWorkbook(){
      const url='analise_financeira_v3.xlsx';
      try{
        const res=await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const arr=await res.arrayBuffer();
        return XLSX.read(arr,{type:'array'});
      }catch(e){
        throw new Error(`Não foi possível carregar ${url}. Verifique se o arquivo está na mesma pasta. Erro: ${e.message}`);
      }
    }

    async function loadViaPicker(){
      if(!window.showOpenFilePicker){
        throw new Error('Seu navegador não suporta o seletor de arquivos moderno. Use "Selecionar Arquivo".');
      }
      try{
        const [handle]=await window.showOpenFilePicker({
          multiple:false,
          types:[{
            description:'Planilhas Excel',
            accept:{
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx'],
              'application/vnd.ms-excel':['.xls']
            }
          }]
        });
        const file=await handle.getFile();
        const arr=await file.arrayBuffer();
        return XLSX.read(arr,{type:'array'});
      }catch(e){
        if(e.name==='AbortError') throw new Error('Seleção cancelada pelo usuário.');
        throw new Error(`Erro ao abrir arquivo: ${e.message}`);
      }
    }

    async function loadViaInput(file){
      if(!file) throw new Error('Nenhum arquivo selecionado.');
      try{
        const arr=await file.arrayBuffer();
        return XLSX.read(arr,{type:'array'});
      }catch(e){
        throw new Error(`Erro ao processar arquivo: ${e.message}`);
      }
    }

    function validateWorkbook(wb){
      const missingRequired=REQUIRED_SHEETS.filter(s=>!hasSheet(wb,s));
      const missingOptional=OPTIONAL_SHEETS.filter(s=>!hasSheet(wb,s));
      if(missingRequired.length){
        throw new Error(`Abas obrigatórias não encontradas: ${missingRequired.join(', ')}`);
      }
      return {missingOptional};
    }

    function statusBadge(sheet, hasData){
      document.querySelectorAll(`[data-status-sheet="${sheet}"]`).forEach(el=>{
        el.dataset.hasData = hasData ? 'true' : 'false';
        el.classList.toggle('hidden', !!hasData);
        const card = el.closest('.card');
        if(card){
          const anyMissing = Array.from(card.querySelectorAll('[data-status-sheet]')).some(b=>b.dataset.hasData==='false');
          card.classList.toggle('card-empty', anyMissing);
        }
      });
    }

    function applySearch(rows){
      if(!state.searchTerm) return rows;
      const term=state.searchTerm.toLowerCase();
      return rows.filter(row=>{
        const keys=['regime','regime_base','segmento','atividade','cliente','linha'].filter(key=>row[key]!==undefined && row[key]!==null);
        if(!keys.length) return true;
        return keys.some(key=> String(row[key]).toLowerCase().includes(term));
      });
    }

    function renderFilterChip(containerId, value, onClear){
      const container=document.getElementById(containerId);
      if(!container) return;
      container.innerHTML='';
      if(!value) return;
      const div=document.createElement('div');
      div.className='chip';
      div.innerHTML=`Filtro: <strong>${value}</strong> <button type="button" aria-label="Limpar filtro">×</button>`;
      div.querySelector('button').addEventListener('click',onClear);
      container.appendChild(div);
    }

    function renderHero(){
      fillKPIs(state.kpis || {});
      const resumo = (state.S?.rr||[])[0]||{};
      const alfa = resumo.alfa_volume ?? resumo.alfa ?? '';
      const beta = resumo.beta_ticket ?? resumo.beta ?? '';
      document.getElementById('meta-alfa').textContent = alfa || '–';
      document.getElementById('meta-beta').textContent = beta || '–';
    }

    function updateResultadoToggle(){
      document.querySelectorAll('[data-resultado-view]').forEach(btn=>{
        const view = btn.getAttribute('data-resultado-view');
        btn.classList.toggle('active', view === state.resultadoView);
      });
    }

    function bindResultadoToggles(){
      document.querySelectorAll('[data-resultado-view]').forEach(btn=>{
        if(btn.dataset.bound) return;
        btn.dataset.bound='true';
        btn.addEventListener('click',()=>{
          const view = btn.getAttribute('data-resultado-view');
          if(!view) return;
          state.resultadoView = view;
          if(view !== 'regimeAtividade'){
            state.filters.segmentRegime = null;
          }
          renderResultado();
        });
      });
    }

    function renderResultado(){
      updateResultadoToggle();
      const chipContainer = document.getElementById('chip-segmento');
      if(chipContainer) chipContainer.innerHTML = '';

      const regimeRows = state.datasets.resultadoRegimeComPeso||[];
      const segmentoRows = state.datasets.resultadoSegmentoComPeso||[];

      if(state.resultadoView === 'regime'){
        const regimesData = applySearch(regimeRows);
        tableFromData('tabResultado',[
          {key:'regime',label:'Regime'},
          {key:'clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
          {key:'ticketMedio',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))},
          {key:'receita',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
          {key:'custo',label:'Custo Mensal',right:true,format:v=>BRL.format(asNum(v))},
          {key:'custoMedio',label:'Custo Médio',right:true,format:v=>BRL.format(asNum(v))},
          {key:'resultado',label:'Resultado',right:true,format:v=>{const val=asNum(v);return (val>=0?'<span class="pill positive">':'<span class="pill negative">')+BRL.format(val)+'</span>';},export:v=>asNum(v)},
          {key:'resultadoMedio',label:'Resultado Médio',right:true,format:v=>BRL.format(asNum(v))},
          {key:'margem',label:'Margem',right:true,format:v=>formatPercentFraction(v)}
        ], regimesData, {
          onRowClick:(row)=>{
            state.filters.segmentRegime=row.regime||null;
            state.resultadoView='regimeAtividade';
            updateResultadoToggle();
            renderResultado();
          },
          getRowClass:(row)=> state.filters.segmentRegime && row.regime===state.filters.segmentRegime ? 'row-active' : '',
          metaSheet:'Resultado_Regime_Com_Peso'
        });
        const hasReg = regimesData.some(r=>asNum(r.receita)||asNum(r.resultado));
        statusBadge('Resultado_Regime_Com_Peso', hasReg);
        statusBadge('Resultado_Segmento_Com_Peso', segmentoRows.length>0);
      }else{
        const filtered = segmentoRows.filter(row=> !state.filters.segmentRegime || row.regime===state.filters.segmentRegime);
        const finalRows = applySearch(filtered);
        tableFromData('tabResultado',[
          {key:'regime',label:'Regime'},
          {key:'atividade',label:'Atividade'},
          {key:'clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
          {key:'receita',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
          {key:'custo',label:'Custo Mensal',right:true,format:v=>BRL.format(asNum(v))},
          {key:'custoMedio',label:'Custo Médio',right:true,format:v=>BRL.format(asNum(v))},
          {key:'resultado',label:'Resultado',right:true,format:v=>{const val=asNum(v);return (val>=0?'<span class="pill positive">':'<span class="pill negative">')+BRL.format(val)+'</span>';},export:v=>asNum(v)},
          {key:'resultadoMedio',label:'Resultado Médio',right:true,format:v=>BRL.format(asNum(v))}
        ], finalRows, {
          getRowClass:(row)=> state.filters.segmentRegime && row.regime===state.filters.segmentRegime ? 'row-active' : '',
          metaSheet:'Resultado_Segmento_Com_Peso'
        });
        statusBadge('Resultado_Regime_Com_Peso', regimeRows.length>0);
        const hasSeg = (segmentoRows||[]).some(r=>asNum(r.receita)||asNum(r.resultado));
        statusBadge('Resultado_Segmento_Com_Peso', hasSeg);
        renderFilterChip('chip-segmento', state.filters.segmentRegime, ()=>{
          state.filters.segmentRegime=null;
          renderResultado();
        });
      }
    }

    function renderROI(){
      const regimes = applySearch(state.datasets.resultadoRegimeComPeso||[]);
      const roiData = regimes.map(r=>({
        regime: r.regime,
        receita: asNum(r.receita),
        custo: asNum(r.custo),
        resultado: asNum(r.resultado),
        roi: asNum(r.custo) > 0 ? (asNum(r.resultado) / asNum(r.custo)) : 0,
        margem: asNum(r.margem)
      })).sort((a,b)=> b.roi - a.roi);

      tableFromData('tabROI', [
        {key:'regime',label:'Regime'},
        {key:'receita',label:'Receita',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo',label:'Custo',right:true,format:v=>BRL.format(asNum(v))},
        {key:'resultado',label:'Resultado',right:true,format:v=>BRL.format(asNum(v))},
        {key:'roi',label:'ROI',right:true,format:v=>{
          const val=asNum(v);
          const color = val>=0.3 ? 'positive' : (val>=0 ? '' : 'negative');
          return `<span class="pill ${color}">${DEC.format(val)}x</span>`;
        },export:v=>asNum(v)},
        {key:'margem',label:'Margem',right:true,format:v=>PCT.format(asNum(v))}
      ], roiData);
    }

    function renderTopClientes(){
      const filterByRegime = row=> !state.filters.ticketRegime || row.regime === state.filters.ticketRegime;
      const base = applySearch((state.datasets.ticketClientes||[]).filter(filterByRegime));
      const clientes = base
        .map(c=>({
          rank: c.rank,
          cliente: c.cliente,
          regime: c.regime,
          ticket: asNum(c.ticket),
          receita: asNum(c.receita_mensal)
        }))
        .sort((a,b)=> b.receita - a.receita)
        .slice(0,20);

      const totalReceita = sum(clientes, c=> c.receita);
      let acumulado = 0;

      const clientesComAcum = clientes.map(c=>{
        acumulado += c.receita;
        const percAcum = totalReceita > 0 ? acumulado / totalReceita : 0;
        return {
          ...c,
          perc_individual: totalReceita > 0 ? c.receita / totalReceita : 0,
          perc_acumulado: percAcum,
          classe_abc: percAcum <= 0.8 ? 'A' : (percAcum <= 0.95 ? 'B' : 'C')
        };
      });

      tableFromData('tabTopClientes', [
        {key:'rank',label:'#',right:true},
        {key:'cliente',label:'Cliente'},
        {key:'regime',label:'Regime'},
        {key:'receita',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'perc_individual',label:'% Individual',right:true,format:v=>PCT.format(asNum(v))},
        {key:'perc_acumulado',label:'% Acumulado',right:true,format:v=>PCT.format(asNum(v))},
        {key:'classe_abc',label:'Classe ABC',right:true,format:v=>{
          const color = v==='A' ? 'ok' : (v==='B' ? 'warn' : '');
          return `<span class="badge ${color}">${v}</span>`;
        }}
      ], clientesComAcum, {
        getRowClass: row => row.classe_abc === 'A' ? 'row-highlight' : '',
        metaSheet:'Ticket_Clientes'
      });
    }

    function updateTicketTabs(){
      document.querySelectorAll('[data-ticket-view]').forEach(btn=>{
        const view = btn.getAttribute('data-ticket-view');
        btn.classList.toggle('active', view === state.ticketView);
      });
    }

    function bindTicketTabs(){
      document.querySelectorAll('[data-ticket-view]').forEach(btn=>{
        if(btn.dataset.bound) return;
        btn.dataset.bound='true';
        btn.addEventListener('click',()=>{
          const view = btn.getAttribute('data-ticket-view');
          if(!view) return;
          state.ticketView = view;
          if(view !== 'regimeAtividade'){
            state.filters.ticketRegime = null;
          }
          renderTickets();
          renderTopClientes();
        });
      });
    }

    function renderTickets(){
      updateTicketTabs();

      const showPlaceholder = (metaSheet)=>{
        const root=document.getElementById('tabTickets');
        if(root){
          root.innerHTML='<div class="empty-message">N/A</div>';
          registerTableData('tabTickets', [], [], metaSheet||null);
        }
      };

      const mapConfig = {
        regime: ()=>{
          const dataset = state.datasets.ticketRegime||[];
          if(!dataset.length){
            console.warn('Ticket médio não encontrado');
            showPlaceholder('Ticket_Regime');
            return;
          }
          const rowsReg = applySearch(dataset);
          const options = {
            onRowClick:(row)=>{
              state.filters.ticketRegime = row?.regime || null;
              state.ticketView = 'regimeAtividade';
              renderTickets();
              renderTopClientes();
            },
            getRowClass:(row)=> state.filters.ticketRegime && row.regime===state.filters.ticketRegime ? 'row-active' : ''
          };
          tableFromData('tabTickets',[
            {key:'regime',label:'Regime'},
            {key:'clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
            {key:'receita',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
            {key:'ticketMedio',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))},
            {key:'perc_receita',label:'% Receita',right:true,format:v=>PCT.format(asNum(v))},
            {key:'perc_clientes',label:'% Clientes',right:true,format:v=>PCT.format(asNum(v))},
            {key:'indice_concentracao',label:'Índice Concentração',right:true,format:v=>DEC.format(asNum(v))}
          ], rowsReg, {...options, metaSheet:'Ticket_Regime'});
        },
        regimeAtividade: ()=>{
          const base = state.datasets.ticketRegimeAtividade||[];
          if(!base.length){
            console.warn('Ticket médio não encontrado');
            showPlaceholder('Ticket_Regime_Atividade');
            return;
          }
          const filtered = base.filter(row=> !state.filters.ticketRegime || row.regime===state.filters.ticketRegime);
          const rows = applySearch(filtered);
          tableFromData('tabTickets',[
            {key:'regime',label:'Regime'},
            {key:'atividade',label:'Atividade'},
            {key:'clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
            {key:'receita',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
            {key:'ticketMedio',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))}
          ], rows, {
            getRowClass:(row)=> state.filters.ticketRegime && row.regime===state.filters.ticketRegime ? 'row-active' : '',
            metaSheet:'Ticket_Regime_Atividade'
          });
        },
        clientes: ()=>{
          const base = state.datasets.ticketClientes||[];
          if(!base.length){
            console.warn('Ticket médio não encontrado');
            showPlaceholder('Ticket_Clientes');
            return;
          }
          const filtered = base.filter(row=> !state.filters.ticketRegime || row.regime===state.filters.ticketRegime);
          const rows = applySearch(filtered);
          tableFromData('tabTickets',[
            {key:'rank',label:'#',right:true,format:v=>INT.format(asNum(v))},
            {key:'cliente',label:'Cliente'},
            {key:'regime',label:'Regime'},
            {key:'atividade',label:'Atividade'},
            {key:'ticket',label:'Ticket Mensal',right:true,format:v=>BRL.format(asNum(v))},
            {key:'receita_mensal',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))}
          ], rows, {metaSheet:'Ticket_Clientes'});
        }
      };

      const exec = mapConfig[state.ticketView] || mapConfig.regime;
      exec();

      statusBadge('Ticket_Regime', (state.datasets.ticketRegime||[]).length>0);
      statusBadge('Ticket_Regime_Atividade', (state.datasets.ticketRegimeAtividade||[]).length>0);
      statusBadge('Ticket_Clientes', (state.datasets.ticketClientes||[]).length>0);

      renderFilterChip('chip-tickets', state.filters.ticketRegime, ()=>{
        state.filters.ticketRegime=null;
        renderTickets();
        renderTopClientes();
      });
    }

    function renderTopDespesas(){
      const top = applySearch(state.datasets.topDespesas||[]);
      tableFromData('tabTopDespesas',[
        {key:'rank',label:'#',right:true,format:v=>INT.format(asNum(v))},
        {key:'grupo',label:'Grupo'},
        {key:'item_nome',label:'Item'},
        {key:'valor',label:'Valor',right:true,format:v=>BRL.format(asNum(v))},
        {key:'perc_total_despesas',label:'% do Total',right:true,format:v=>PCT.format(asNum(v))}
      ], top, {metaSheet:'Top_Despesas'});
      statusBadge('Top_Despesas', (state.datasets.topDespesas||[]).length>0);
    }

    function formatPercentFraction(value){
      if(value===null || value===undefined) return '—';
      const num = Number(value);
      if(!Number.isFinite(num)) return '—';
      return PCT.format(num);
    }

    function renderDRE(){
      const raw = state.S?.dre || [];
      const dre = (raw||[]).map(row=>{
        const receita = pick(row,'percentual_receita_total','DRE_Simplificada');
        const resultado = pick(row,'percentual_resultado_operacional','DRE_Simplificada');
        return {
          bloco: pick(row,'bloco','DRE_Simplificada') || '',
          linha: pick(row,'linha','DRE_Simplificada') || '',
          valor_total: asNum(pick(row,'valor_total','DRE_Simplificada')),
          valor_mensal: asNum(pick(row,'valor_mensal','DRE_Simplificada')),
          percentual_receita_total: receita === undefined ? null : asNum(receita),
          percentual_resultado_operacional: resultado === undefined ? null : asNum(resultado),
          observacao: pick(row,'observacao','DRE_Simplificada') || ''
        };
      });

      const finalDRE = applySearch(dre);
      const cols = [
        {key:'linha',label:'Linha'},
        {key:'valor_total',label:'Valor Total',right:true,format:v=>BRL.format(asNum(v))},
        {key:'valor_mensal',label:'Valor Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'percentual_receita_total',label:'% Receita',right:true,format:v=>formatPercentFraction(v)}
      ];
      const hasPercLucro = dre.some(row=> Number.isFinite(row.percentual_resultado_operacional));
      if(hasPercLucro){
        cols.push({
          key:'percentual_resultado_operacional',
          label:'% Lucro Líquido',
          right:true,
          format:v=>formatPercentFraction(v)
        });
      }
      const hasObs = dre.some(row=> row && (row.observacao!==undefined && String(row.observacao||'').trim()!==''));
      if(hasObs){
        cols.push({key:'observacao',label:'Observações'});
      }
      tableFromData('tabDRE',cols, finalDRE, {
        getRowClass:(row)=>{
          const linha = String(row.linha||'').toLowerCase();
          if(linha.includes('margem') || linha.includes('resultado')) return 'row-highlight';
          return '';
        },
        metaSheet:'DRE_Simplificada'
      });
      statusBadge('DRE_Simplificada', raw.length>0);
    }

    function renderMargem(){
      const totalEl = document.querySelector('#margem-total .value');
      const mensalEl = document.querySelector('#margem-mensal .value');
      const clienteEl = document.querySelector('#margem-cliente .value');
      const clientesBadge = document.getElementById('margem-clientes-total');
      if(!totalEl || !mensalEl || !clienteEl || !clientesBadge) return;

      const base = state.datasets.margemContribuicao || [];
      const margemColumns = [
        {key:'margem_total',label:'Margem Total',exportType:'currency'},
        {key:'margem_mensal',label:'Margem Mensal',exportType:'currency'},
        {key:'clientes_total',label:'Clientes Totais',exportType:'number'},
        {key:'margem_por_cliente',label:'Margem por Cliente (mensal)',exportType:'currency'}
      ];
      if(!base.length){
        totalEl.textContent = '—';
        mensalEl.textContent = '—';
        clienteEl.textContent = '—';
        clientesBadge.textContent = '— clientes';
        registerTableData('cardMargem', margemColumns, [], 'DRE_Margem_Contribuicao');
        statusBadge('DRE_Margem_Contribuicao', false);
        return;
      }

      const registro = base[0];
      const total = asNum(registro.margem_total);
      const mensal = asNum(registro.margem_mensal);
      const clientesRaw = asNum(registro.clientes_total);
      const clientes = Math.max(0, Math.floor(clientesRaw));
      const porCliente = asNum(registro.margem_por_cliente);

      totalEl.textContent = BRL.format(total);
      mensalEl.textContent = BRL.format(mensal);
      clienteEl.textContent = BRL.format(porCliente);
      clientesBadge.textContent = `${INT.format(clientes)} clientes`;
      registerTableData('cardMargem', margemColumns, [{
        margem_total: total,
        margem_mensal: mensal,
        clientes_total: clientesRaw,
        margem_por_cliente: porCliente
      }], 'DRE_Margem_Contribuicao');
      statusBadge('DRE_Margem_Contribuicao', true);
    }

    function renderValidations(){
      const list=document.getElementById('validations-list');
      const checks=[];
      const ticketReg=state.datasets.ticketRegime||[];
      ticketReg.forEach(row=>{
        const receita=asNum(row.receita);
        const reconstruida=asNum(row.ticketMedio)*asNum(row.clientes);
        const diff=percentDiff(receita,reconstruida);
        const abs=Math.abs(diff);
        let status='ok';
        if(abs>0.03) status='error';
        else if(abs>0.01) status='warn';
        checks.push({
          status,
          title:`Ticket × Receita — ${row.regime||'Regime'}`,
          diff,
          detail:`Receita informada: ${BRL.format(receita)} | Receita reconstruída: ${BRL.format(reconstruida)} | Desvio: ${PCT.format(diff)}`
        });
      });

      if(ticketReg.length){
        const somaReg= sum(ticketReg,r=> r.receita);
        const geralRaw = state.S?.g?.[0] || {};
        const geral=asNum(pick(geralRaw,'receita_mensal','Ticket_Geral')) || state.kpis?.receitaMensal || 0;
        const diff=percentDiff(geral,somaReg);
        let status='ok';
        if(Math.abs(diff)>0.03) status='error';
        else if(Math.abs(diff)>0.01) status='warn';
        checks.push({
          status,
          title:'Receita Total Ticket Regime × Ticket Geral',
          diff,
          detail:`Ticket Geral: ${BRL.format(geral)} | Soma Regimes: ${BRL.format(somaReg)} | Desvio: ${PCT.format(diff)}`
        });
      }

      const totalCom = sum(state.datasets.resultadoRegimeComPeso||[], r=> r.resultado);
      const diffCom = percentDiff(state.kpis?.resultadoTotal||0, totalCom);
      checks.push({
        status:Math.abs(diffCom)<=0.03?'ok':'warn',
        title:'Somatório Resultado Consolidado',
        diff:diffCom,
        detail:`KPI: ${BRL.format(state.kpis?.resultadoTotal||0)} | Soma Regimes: ${BRL.format(totalCom)}`
      });

      const segmentosRows = state.datasets.resultadoSegmentoComPeso||[];
      if(segmentosRows.length){
        const segmentos = new Map();
        segmentosRows.forEach(row=>{
          const key=String(row.regime||'').toLowerCase();
          segmentos.set(key,(segmentos.get(key)||0)+asNum(row.resultado));
        });
        const divergencias=[];
        (state.datasets.resultadoRegimeComPeso||[]).forEach(row=>{
          const somaSeg = segmentos.get(String(row.regime||'').toLowerCase())||0;
          const diff=percentDiff(asNum(row.resultado), somaSeg);
          if(Math.abs(diff)>0.01){
            divergencias.push(`${row.regime||'Regime'} → ${PCT.format(diff)} (Regime: ${BRL.format(asNum(row.resultado))} | Segmentos: ${BRL.format(somaSeg)})`);
          }
        });
        checks.push({
          status:divergencias.length?'warn':'ok',
          title:'Segmento (Regime + Atividade) × Regime consolidado',
          diff:0,
          detail:divergencias.length?divergencias.join('\n'):'Sem divergências relevantes (≤1%)'
        });
      }

      list.innerHTML='';
      if(!checks.length){
        list.innerHTML='<div class="empty-message">Sem validações disponíveis.</div>';
        return;
      }

      checks.forEach((check,idx)=>{
        const row=document.createElement('div');
        row.className=`validation-row ${check.status}`;
        const icon = check.status==='ok'?'✅':(check.status==='warn'?'⚠️':'❌');
        const badgeClass = check.status==='ok'?'badge ok':(check.status==='warn'?'badge warn':'badge error');
        const diffLabel = `${check.diff>=0?'+':''}${PCT.format(check.diff||0)}`;
        row.innerHTML=`<div class="header"><div class="header-left">${icon} ${check.title}</div><span class="${badgeClass}">${diffLabel}</span></div>`;
        const details=document.createElement('details');
        const summary=document.createElement('summary');
        summary.textContent='ver cálculo';
        const pre=document.createElement('div');
        pre.textContent=check.detail;
        details.appendChild(summary);
        details.appendChild(pre);
        row.appendChild(details);
        list.appendChild(row);
      });
    }

    function renderAll(){
      renderHero();
      renderResultado();
      renderROI();
      renderTickets();
      renderTopClientes();
      renderTopDespesas();
      renderDRE();
      renderMargem();
      renderValidations();
    }

    function resolveColumnType(metaSheet, column){
      if(column.exportType) return column.exportType;
      if(!metaSheet) return '';
      const schema = schemas[canonicalSheetName(metaSheet)];
      if(!schema) return '';
      const key = normalizeKey(column.key || column.label || '');
      const entry = schema.lookup[key];
      if(!entry) return '';
      const tipo = String(entry.tipo||'').toLowerCase();
      if(tipo.includes('percent')) return 'percent';
      if(tipo.includes('moeda') || tipo.includes('currency')) return 'currency';
      if(tipo.includes('valor') || tipo.includes('numero') || tipo.includes('quantidade') || tipo.includes('qtd') || tipo.includes('inteiro')) return 'number';
      if(tipo.includes('texto') || tipo.includes('descricao')) return 'string';
      return '';
    }

    function toNumberMaybe(value, typeHint){
      if(value===null || value===undefined) return {valid:false};
      if(typeof value==='number' && Number.isFinite(value)){
        return {valid:true,value};
      }
      if(typeof value!=='string') return {valid:false};
      const trimmed=value.trim();
      if(!trimmed) return {valid:false};
      const cleaned = trimmed.replace(/\u00a0/g,'').replace(/[^0-9,\.\-]/g,'');
      if(!/[0-9]/.test(cleaned)) return {valid:false};
      const percent = /%/.test(trimmed);
      let prepared = cleaned;
      if(cleaned.includes(',')){
        prepared = cleaned.replace(/\./g,'').replace(',','.');
      }
      const num=Number(prepared);
      if(!Number.isFinite(num)) return {valid:false};
      if(typeHint==='percent' || percent){
        const valuePct = percent ? num/100 : num;
        return {valid:true,value:valuePct};
      }
      return {valid:true,value:num};
    }

    function csvEscape(text){
      return `"${String(text).replace(/"/g,'""')}"`;
    }

    function serializeCsvValue(raw, column, metaSheet){
      if(raw===null || raw===undefined) return '';
      const typeHint = resolveColumnType(metaSheet, column);
      if(typeof raw==='number'){
        return Number.isFinite(raw) ? raw : '';
      }
      if(typeHint==='string'){
        return csvEscape(raw);
      }
      const numResult = toNumberMaybe(String(raw), typeHint);
      if(numResult.valid){
        return numResult.value;
      }
      return csvEscape(raw);
    }

    function exportCsv(targetId){
      const table=TABLE_CACHE[targetId];
      if(!table||!table.rows||!table.rows.length){
        showToast('Sem dados para exportar.', 'error');
        return;
      }
      const {columns,rows,metaSheet}=table;
      const header=columns.map(c=>csvEscape(c.label||c.key||''));
      const lines=rows.map(row=>columns.map(c=>{
        const raw = c.export ? c.export(row[c.key], row) : row[c.key];
        return serializeCsvValue(raw, c, metaSheet||null);
      }).join(';'));
      const csv=[header.join(';'),...lines].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`${targetId}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),5000);
      showToast('Exportação gerada com sucesso!','success');
    }

    function renderDashboard(wb){
      try{
        const sheetStatus=validateWorkbook(wb);
        state.wb=wb;
        schemas = buildSchemas(wb);
        state.sheetStatus=sheetStatus;
        state.filters={segmentRegime:null,ticketRegime:null};
        state.searchTerm='';
        state.resultadoView='regime';
        state.ticketView='regime';
        Object.keys(TABLE_CACHE).forEach(k=> delete TABLE_CACHE[k]);

        const S = getSheets(wb);
        window._S = S;
        state.S = S;

        const KPIs = computeKPIs(S);
        state.kpis = KPIs;

        const rrCom = rowsResultadoRegime(S.rc,'Resultado_Regime_Com_Peso');
        const seg = rowsResultadoSegmento(S.segc);
        const tkBase = rowsTicketRegime(S.tr);
        const totalReceitaTk = sum(tkBase,r=>r.receita) || 1;
        const totalClientesTk = sum(tkBase,r=>r.clientes) || 1;
        const tkReg = tkBase.map(r=>{
          const percReceita = totalReceitaTk ? r.receita/totalReceitaTk : 0;
          const percClientes = totalClientesTk ? r.clientes/totalClientesTk : 0;
          const indice = percClientes ? percReceita/percClientes : 0;
          return {...r, perc_receita:percReceita, perc_clientes:percClientes, indice_concentracao:indice};
        });

        const tkRegAtividade = rowsTicketRegimeAtividade(S.tra);
        const tkClientes = rowsTicketClientes(S.tc);
        const topG = rowsTopDespesas(S.td);
        const margem = rowsMargemContribuicao(S.mc);

        state.datasets={
          resultadoRegimeComPeso:rrCom,
          resultadoSegmentoComPeso:seg,
          ticketRegime:tkReg,
          ticketRegimeAtividade:tkRegAtividade,
          ticketClientes:tkClientes,
          topDespesas:topG,
          margemContribuicao:margem,
          dre:S.dre
        };

        document.querySelector('.subtitle').textContent = `✅ Planilha carregada com sucesso - ${wb.SheetNames.length} abas`;
        if(sheetStatus.missingOptional.length){
          showStatus(`⚠️ Abas opcionais ausentes: ${sheetStatus.missingOptional.join(', ')}`, 'info');
        }else{
          showStatus('✅ Dashboard renderizado com sucesso!', 'success');
        }

        const searchInput=document.getElementById('global-search');
        if(searchInput && !searchInput.dataset.bound){
          searchInput.dataset.bound='true';
          searchInput.addEventListener('input',e=>{
            state.searchTerm=e.target.value.trim();
            renderAll();
          });
        }
        if(searchInput){
          searchInput.value='';
        }

        document.querySelectorAll('[data-export]').forEach(btn=>{
          if(btn.dataset.bound) return;
          btn.dataset.bound='true';
          btn.addEventListener('click',()=>exportCsv(btn.getAttribute('data-export')));
        });

        bindResultadoToggles();
        bindTicketTabs();

        document.querySelectorAll('[data-excel]').forEach(btn=>{
          if(btn.dataset.bound) return;
          btn.dataset.bound='true';
          btn.addEventListener('click',()=>{
            const sheet=btn.getAttribute('data-excel');
            showToast(`Abra a aba "${sheet}" na planilha para consultar o detalhamento.`, 'info');
          });
        });

        renderAll();
        showToast('Relatório carregado com sucesso!', 'success');
      }catch(e){
        console.error('Erro ao renderizar:', e);
        showStatus(`❌ Erro ao processar dados: ${e.message}`, 'error');
        showToast(e.message, 'error');
      }
    }
    function testWorkbook(wb) {
      let report = '<div class="diagnostic">';
      report += `<strong>✅ Planilha carregada com sucesso!</strong><br><br>`;
      report += `<strong>Abas encontradas (${wb.SheetNames.length}):</strong><br>`;

      const expectedSheets = REQUIRED_SHEETS.concat(OPTIONAL_SHEETS);
      const isExpectedSheet = (sheetName)=>{
        const lower = String(sheetName).toLowerCase();
        return expectedSheets.some(expected=> sheetCandidateNames(expected).some(candidate=>candidate.toLowerCase()===lower));
      };

      expectedSheets.forEach(name => {
        const actual = findSheetName(wb, name);
        const exists = !!actual;
        const icon = exists ? '✅' : '❌';
        const label = actual && actual !== name ? `${name} → ${actual}` : name;
        report += `${icon} ${label}`;
        if (exists) {
          const data = tryGetSheet(wb, actual);
          report += ` (${data ? data.length : 0} linhas)`;
        }
        report += '<br>';
      });

      const outros = wb.SheetNames.filter(s => !isExpectedSheet(s));
      if(outros.length){
        report += '<br><strong>Outras abas:</strong><br>';
        outros.forEach(s => {
          const data = tryGetSheet(wb, s);
          report += `ℹ️ ${s} (${data ? data.length : 0} linhas)<br>`;
        });
      }

      report += '</div>';
      showStatus(report, 'info');
    }

    async function boot(method='auto'){
      showLoading(true);
      showStatus('⏳ Carregando planilha...', 'info');

      try{
        let wb;

        if(method==='auto'){
          try{
            wb=await fetchRelativeWorkbook();
            showToast('Planilha carregada automaticamente', 'success');
          }catch(e1){
            console.warn('Fetch automático falhou:', e1.message);
            throw new Error('Não foi possível carregar automaticamente. Use um dos botões para selecionar o arquivo manualmente.');
          }
        }else if(method==='picker'){
          wb=await loadViaPicker();
          showToast('Planilha carregada via seletor', 'success');
        }

        if(wb){
          renderDashboard(wb);
        }
      }catch(e){
        console.error('Erro no boot:', e);
        showStatus(`❌ ${e.message}<br><br>📌 <strong>Como resolver:</strong><br>
          1. Certifique-se que o arquivo <code>analise_financeira_v3.xlsx</code> está na mesma pasta que este HTML<br>
          2. Use o botão "📁 Selecionar Arquivo" para escolher o arquivo manualmente<br>
          3. Ou use "📂 Seletor do Sistema" (se seu navegador suportar)`, 'error');
        showToast(e.message, 'error');
      }finally{
        showLoading(false);
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', async ()=>{
      await boot('auto');
    });

    document.getElementById('btn-picker').addEventListener('click', async ()=>{
      showLoading(true);
      try{
        const wb=await loadViaPicker();
        renderDashboard(wb);
      }catch(e){
        showToast(e.message, 'error');
        showStatus(`❌ ${e.message}`, 'error');
      }finally{
        showLoading(false);
      }
    });

    document.getElementById('file-input').addEventListener('change', async (e)=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      showLoading(true);
      try{
        const wb=await loadViaInput(f);
        renderDashboard(wb);
        showToast(`Arquivo ${f.name} carregado com sucesso!`, 'success');
      }catch(e){
        showToast(e.message, 'error');
        showStatus(`❌ ${e.message}`, 'error');
      }finally{
        showLoading(false);
      }
    });

    document.getElementById('btn-test').addEventListener('click', async ()=>{
      showLoading(true);
      try{
        let wb;
        try{
          wb=await fetchRelativeWorkbook();
        }catch(e){
          wb=await loadViaPicker();
        }
        testWorkbook(wb);
        showToast('Teste concluído! Veja os detalhes acima.', 'info');
      }catch(e){
        showToast(e.message, 'error');
        showStatus(`❌ ${e.message}`, 'error');
      }finally{
        showLoading(false);
      }
    });

    boot('auto');
  </script>
</body>
</html>
