<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório Financeiro - Análise v3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --ink:#e5e7eb;
      --ink-dim:#94a3b8;
      --accent:#22c55e;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --negative:#fecaca;
      --positive:#bbf7d0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 20% -10%, #172554 0%, transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, #052e16 0%, transparent 60%), var(--bg);
    }
    header{
      padding:28px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#22c55e 0%,#0ea5e9 60%,#a78bfa 100%);box-shadow:var(--shadow);}
    h1{font-size:22px;margin:0;font-weight:800}
    .subtitle{color:var(--ink-dim);font-size:13px;margin-top:2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{background:linear-gradient(180deg,#1f2937,#111827);color:var(--ink);border:1px solid #334155;padding:10px 14px;border-radius:12px;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s ease;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    button:hover,.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:#475569}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#16a34a;color:#03180d}
    .btn-warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#d97706;color:#1a0f00}
    .btn-ghost{background:transparent;border-color:transparent;color:#60a5fa;padding:6px 8px;border-radius:8px}
    .btn-ghost:hover{background:#1e293b;transform:none;box-shadow:none}
    .btn-sm{padding:6px 10px;font-size:12px;border-radius:10px}
    .btn-link{background:none;border:none;color:#60a5fa;font-weight:600;padding:0;cursor:pointer}
    .btn-link:hover{text-decoration:underline;transform:none;box-shadow:none}
    .container{padding:0 22px 80px}
    .grid{display:grid;gap:16px}
    .grid.auto-fit{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),var(--panel);border:1px solid #233045;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;position:relative}
    .card.card-empty{opacity:.7}
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .card-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .kpi{padding:18px;background:linear-gradient(180deg,rgba(34,197,94,.09),rgba(34,197,94,.03)),#0b1324;border:1px solid rgba(34,197,94,.25);border-radius:16px;display:flex;flex-direction:column;gap:6px}
    .kpi.alt{background:linear-gradient(180deg,rgba(96,165,250,.08),rgba(96,165,250,.03)),#0b1324;border-color:rgba(96,165,250,.35)}
    .kpi.warn{background:linear-gradient(180deg,rgba(245,158,11,.10),rgba(245,158,11,.03)),#0b1324;border-color:rgba(245,158,11,.35)}
    .kpi .label{color:#99f6e4;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
    .kpi .value{font-size:26px;font-weight:800}
    .kpi .desc{color:var(--ink-dim);font-size:12px}
    .hero{border-radius:20px;padding:20px 18px;margin-bottom:18px;background:radial-gradient(800px 300px at 20% -10%,rgba(34,197,94,.18),transparent 60%),linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),#0b1324;border:1px solid #1e293b;box-shadow:var(--shadow)}
    .divider{height:1px;background:#1f2a3c;margin:14px 0}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3546;background:#0a1322;border-radius:999px;font-size:12px;color:#cbd5e1;margin-right:8px;margin-bottom:6px}
    .search-bar{margin-top:16px;display:flex;justify-content:flex-end}
    .search-bar input{width:320px;max-width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1f2a3c;background:#0b1324;color:var(--ink);font-size:13px}
    .search-bar input::placeholder{color:#475569}
    .tabs{display:flex;gap:8px;margin:6px 0 14px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #334155;background:#0b1324;color:#cbd5e1;font-weight:600;font-size:12px;cursor:pointer}
    .tab.active{border-color:#60a5fa;background:linear-gradient(180deg,rgba(59,130,246,.18),rgba(59,130,246,.06));color:#e2e8f0}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{color:#9ca3af;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;text-align:left;padding:8px}
    tbody td{padding:10px 8px;background:#0a1220;border-top:1px solid #20314a;border-bottom:1px solid #20314a}
    tbody tr{transition:transform .2s ease,background .2s ease}
    tbody tr:hover{transform:translateY(-1px);background:rgba(148,163,184,.08)}
    tbody td:first-child{border-left:1px solid #20314a;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid #20314a;border-top-right-radius:12px;border-bottom-right-radius:12px;text-align:right}
    tbody tr.row-active{background:rgba(96,165,250,.18)}
    .muted{color:var(--ink-dim)}
    .small{font-size:12px}
    .hidden{display:none}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;background:#0a162b;border:1px solid #22324f;color:#e2e8f0}
    .pill.negative{background:#2a0a10;border-color:#4c1d1d;color:var(--negative)}
    .pill.positive{background:#062a17;border-color:#064e3b;color:var(--positive)}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;border:1px solid #334155;background:#152039;color:#cbd5e1}
    .badge.error{border-color:#b91c1c;background:#451313;color:#fecaca}
    .badge.warn{border-color:#d97706;background:#3f2205;color:#facc15}
    .badge.ok{border-color:#16a34a;background:#052b19;color:#bbf7d0}
    .filter-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:#0b1324;border:1px solid #1f2a3c;font-size:12px}
    .chip button{background:none;border:none;color:#60a5fa;font-weight:700;cursor:pointer}
    .validation-list{display:flex;flex-direction:column;gap:10px}
    .validation-row{display:flex;flex-direction:column;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid #1f2a3c;background:#0a1320}
    .validation-row .header{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:13px}
    .validation-row .header-left{display:flex;align-items:center;gap:8px;font-weight:600}
    .validation-row.ok{border-color:#14532d}
    .validation-row.warn{border-color:#b45309}
    .validation-row.error{border-color:#7f1d1d}
    .validation-row details{font-family:monospace;font-size:11px;background:#050a17;border-radius:8px;padding:8px}
    .validation-row details summary{cursor:pointer;font-size:11px;font-weight:600;color:#60a5fa}
    .bar-cell{display:flex;align-items:center;gap:8px;justify-content:flex-end}
    .bar-cell .bar-wrapper{flex:0 0 120px;background:#1e293b;border-radius:999px;overflow:hidden;height:6px}
    .bar-cell .bar{height:100%;background:linear-gradient(90deg,#22d3ee,#2563eb)}
    .status-note{font-size:12px;color:#eab308}
    #toast{position:fixed;bottom:18px;right:18px;background:#111827;border:1px solid #334155;padding:12px 14px;border-radius:10px;color:#e2e8f0;box-shadow:var(--shadow);display:none;max-width:400px;z-index:9999}
    #toast.error{border-color:#dc2626;background:#1f0808}
    #toast.success{border-color:#22c55e;background:#062a17}
    #loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999}
    #loading.show{display:flex}
    .spinner{width:60px;height:60px;border:4px solid #334155;border-top-color:#22c55e;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .alert{padding:16px;border-radius:12px;margin:16px 0;border:1px solid}
    .alert.error{background:#2a0a10;border-color:#4c1d1d;color:#fecaca}
    .alert.info{background:#0a1b2e;border-color:#1e3a5f;color:#93c5fd}
    .alert.success{background:#062a17;border-color:#064e3b;color:#bbf7d0}
    .card .empty-message{color:var(--ink-dim);font-size:12px;padding:8px 4px}
    @media print{
      body{background:#fff;color:#000}
      header,.toolbar,button,.btn,#toast,#loading{display:none!important}
      .hero,.card{box-shadow:none;border:1px solid #ccc;background:#fff;color:#000}
      .card{page-break-inside:avoid}
      .tabs,.tab{display:none!important}
      .hidden{display:block!important}
      .chip button{display:none}
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="loading"><div class="spinner"></div></div>

  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Relatório Financeiro — Análise v3</h1>
        <div class="subtitle">Aguardando carregamento da planilha...</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btn-refresh">🔄 Recarregar</button>
      <label class="btn">
        <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none">
        📁 Selecionar Arquivo
      </label>
      <button class="btn" id="btn-picker">📂 Seletor do Sistema</button>
      <button class="btn btn-warn" id="btn-test">🔍 Testar Planilha</button>
      <button class="btn" onclick="window.print()">🖨️ Imprimir</button>
    </div>
  </header>

  <main class="container">
    <div id="status-area"></div>

    <section class="hero">
      <h2>Visão Executiva</h2>
      <p class="muted">Principais resultados e impactos — tickets, custos alocados e resultado por regime.</p>
      <div class="grid auto-fit">
        <div class="kpi" id="kpi-receita-mensal">
          <div class="label">Receita Mensal Total</div>
          <div class="value">—</div>
          <div class="desc"><span id="kpi-qtd-clientes" class="pill">— clientes</span></div>
        </div>
        <div class="kpi alt" id="kpi-ticket-medio">
          <div class="label">Ticket Médio Mensal</div>
          <div class="value">—</div>
          <div class="desc">Valor médio por cliente</div>
        </div>
        <div class="kpi" id="kpi-custo-medio">
          <div class="label">Custo Médio Mensal (cliente)</div>
          <div class="value">—</div>
          <div class="desc">Baseado em custos alocados</div>
        </div>
        <div class="kpi" id="kpi-resultado-medio">
          <div class="label">Resultado Médio Mensal (cliente)</div>
          <div class="value">—</div>
          <div class="desc">Considerando rateio com peso</div>
        </div>
        <div class="kpi" id="kpi-resultado-sem-peso">
          <div class="label">Resultado Total (Sem Peso)</div>
          <div class="value">—</div>
          <div class="desc"><span id="kpi-margem-sem-peso" class="pill">—</span></div>
        </div>
        <div class="kpi warn" id="kpi-resultado-com-peso">
          <div class="label">Resultado Total (Com Peso)</div>
          <div class="value">—</div>
          <div class="desc"><span id="kpi-margem-com-peso" class="pill">—</span></div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="tag">Alfa (volume): <strong id="meta-alfa">—</strong></div>
      <div class="tag">Beta (ticket): <strong id="meta-beta">—</strong></div>
      <div class="tag">Abatimento Advocacia em ADM: <strong id="meta-adv">—</strong></div>
      <div class="search-bar">
        <input type="search" id="global-search" placeholder="Buscar por regime, segmento ou cliente...">
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2 style="margin:0">Resultado por Regime</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="Resultado_Regime_Sem_Peso">Sem dados</span>
          <span class="badge warn hidden" data-status-sheet="Resultado_Regime_Com_Peso">Sem dados</span>
          <button class="btn-sm" data-export="tabRegimeSemPeso">⬇️ Exportar CSV</button>
          <button class="btn-sm" data-export="tabRegimeComPeso">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="tabRegimeSemPeso">Sem Peso</button>
        <button class="tab" data-tab="tabRegimeComPeso">Com Peso</button>
      </div>
      <div id="tabRegimeSemPeso"></div>
      <div id="tabRegimeComPeso" class="hidden"></div>
    </section>

    <div class="grid cols-2" style="margin-top:16px">
      <section class="card" id="card-segmento">
        <div class="card-header">
          <h2 style="margin:0">Resultado por Regime + Atividade (Com Peso)</h2>
          <div class="card-actions">
            <span class="badge warn hidden" data-status-sheet="Resultado_Segmento_Com_Peso">Sem dados</span>
            <button class="btn-sm" data-export="tabSegmentoComPeso">⬇️ Exportar CSV</button>
          </div>
        </div>
        <div class="filter-chips" id="chip-segmento"></div>
        <div id="tabSegmentoComPeso"></div>
      </section>
      <section class="card" id="card-tickets">
        <div class="card-header">
          <h2 style="margin:0">Tickets Médios</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="Ticket_Regime">Sem dados</span>
          <span class="badge warn hidden" data-status-sheet="Ticket_Regime_Atividade">Sem dados</span>
          <span class="badge warn hidden" data-status-sheet="Ticket_Clientes">Sem dados</span>
          <button class="btn-sm" data-export="tabTicketsRegime">⬇️ Exportar CSV</button>
          <button class="btn-sm" data-export="tabTicketsRegAtiv">⬇️ Exportar CSV</button>
          <button class="btn-sm" data-export="tabTicketsClientes">⬇️ Exportar CSV</button>
        </div>
        </div>
        <div class="tabs">
          <button class="tab active" data-tab="tabTicketsRegime">Por Regime</button>
          <button class="tab" data-tab="tabTicketsRegAtiv">Regime + Atividade</button>
          <button class="tab" data-tab="tabTicketsClientes">Top Clientes</button>
        </div>
        <div class="filter-chips" id="chip-tickets"></div>
        <div id="tabTicketsRegime"></div>
        <div id="tabTicketsRegAtiv" class="hidden"></div>
        <div id="tabTicketsClientes" class="hidden"></div>
      </section>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <section class="card" id="card-top-desp">
        <div class="card-header">
          <h2 style="margin:0">Top Despesas (Geral)</h2>
          <div class="card-actions">
            <span class="badge warn hidden" data-status-sheet="Top_Despesas">Sem dados</span>
            <button class="btn-sm" data-export="tabTopDespesas">⬇️ Exportar CSV</button>
            <button class="btn-ghost" data-excel="Top_Despesas">Ver no Excel</button>
          </div>
        </div>
        <div id="tabTopDespesas"></div>
      </section>
      <section class="card" id="card-top-desp-adm">
        <div class="card-header">
          <h2 style="margin:0">Top Despesas Administrativas</h2>
          <div class="card-actions">
            <span class="badge warn hidden" data-status-sheet="Top_Despesas_Adm">Sem dados</span>
            <button class="btn-sm" data-export="tabTopDespesasAdm">⬇️ Exportar CSV</button>
            <button class="btn-ghost" data-excel="Top_Despesas_Adm">Ver no Excel</button>
          </div>
        </div>
        <div id="tabTopDespesasAdm"></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px" id="card-resumo">
      <div class="card-header">
        <h2 style="margin:0">Resumo de Retirada (sem pró-labore no resultado)</h2>
        <div class="card-actions">
          <span class="badge warn hidden" data-status-sheet="Resumo_Retirada">Sem dados</span>
          <button class="btn-sm" data-export="tabResumoRetirada">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div id="tabResumoRetirada"></div>
    </section>

    <section class="card" style="margin-top:16px" id="card-validacoes">
      <div class="card-header">
        <h2 style="margin:0">Validações & Confrontos</h2>
      </div>
      <div class="validation-list" id="validations-list"></div>
    </section>

    <section class="card" style="margin-top:16px" id="card-comparativo">
      <div class="card-header">
        <h2 style="margin:0">Comparativo de Impacto — Sem Peso × Com Peso</h2>
        <div class="card-actions">
          <button class="btn-sm" data-export="tabComparativo">⬇️ Exportar CSV</button>
        </div>
      </div>
      <div id="tabComparativo"></div>
    </section>

  </main>
  <div id="toast"></div>

  <script>
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const DEC2 = new Intl.NumberFormat('pt-BR',{maximumFractionDigits:2,minimumFractionDigits:0});
    const INT = new Intl.NumberFormat('pt-BR',{maximumFractionDigits:0});
    const PCT1 = new Intl.NumberFormat('pt-BR',{style:'percent',maximumFractionDigits:1});

    const state = {
      wb:null,
      datasets:{},
      filters:{segmentRegime:null,ticketRegime:null},
      searchTerm:'',
      sheetStatus:{missingOptional:[]}
    };

    const TABLE_CACHE = {};

    const REQUIRED_SHEETS = [
      'Ticket_Geral',
      'Resultado_Regime_Sem_Peso',
      'Resultado_Regime_Com_Peso',
      'Resumo_Retirada'
    ];

    const OPTIONAL_SHEETS = [
      'Ticket_Regime',
      'Ticket_Regime_Atividade',
      'Ticket_Clientes',
      'Resultado_Segmento_Com_Peso',
      'Top_Despesas',
      'Top_Despesas_Adm'
    ];

    const showLoading = (show)=>{
      document.getElementById('loading').classList.toggle('show', show);
    };

    const showToast = (msg, type='info')=>{
      const t=document.getElementById('toast');
      t.textContent=msg;
      t.className=type;
      t.style.display='block';
      clearTimeout(showToast._timer);
      showToast._timer=setTimeout(()=>t.style.display='none',5000);
    };

    const showStatus = (msg, type='info')=>{
      const area=document.getElementById('status-area');
      area.innerHTML=`<div class="alert ${type}">${msg}</div>`;
    };

    const asNum = (v)=>{
      if(v===null||v===undefined) return 0;
      if(typeof v==='number') return v;
      if(typeof v==='string'){
        const s=v.replace(/[R$\s\.]/g,'').replace(',','.');
        const n=parseFloat(s);
        return isNaN(n)?0:n;
      }
      return Number(v)||0;
    };

    const normalizeKey = (k)=> String(k||'').trim().toLowerCase()
      .replace(/[àáâãäå]/g,'a')
      .replace(/[èéêë]/g,'e')
      .replace(/[ìíîï]/g,'i')
      .replace(/[òóôõö]/g,'o')
      .replace(/[ùúûü]/g,'u')
      .replace(/[ç]/g,'c')
      .replace(/\s+/g,'_')
      .replace(/[^\w_]/g,'');

    const mapRow = (row)=>{
      const m={};
      Object.keys(row||{}).forEach(k=>{
        const nk=normalizeKey(k);
        m[nk]=row[k];
      });
      return m;
    };

    const normalizeRows = (rows, aliasMap={})=>{
      if(!Array.isArray(rows)) return [];
      return rows.map(r=>{
        const mapped=mapRow(r);
        Object.entries(aliasMap).forEach(([target, aliases])=>{
          if(mapped[target]!==undefined && mapped[target]!==null && mapped[target]!== '') return;
          for(const alias of aliases){
            if(alias in mapped && mapped[alias]!==undefined && mapped[alias]!==null && mapped[alias]!== ''){
              mapped[target]=mapped[alias];
              break;
            }
          }
          aliases.forEach(alias=>{
            if(alias!==target && alias in mapped) delete mapped[alias];
          });
        });
        return mapped;
      });
    };

    const sumBy = (rows, key)=> (rows||[]).reduce((acc,row)=>acc+asNum(row[key]),0);

    const groupBy = (rows, key)=>{
      const map=new Map();
      (rows||[]).forEach(row=>{
        const k=Array.isArray(key)?key.map(kp=>row[kp]).join('||'):row[key];
        if(!map.has(k)) map.set(k,[]);
        map.get(k).push(row);
      });
      return map;
    };

    const percentDiff = (expected, observed)=>{
      const exp=asNum(expected);
      const obs=asNum(observed);
      const denom = Math.abs(exp) > 1e-6 ? Math.abs(exp) : Math.abs(obs) || 1;
      return (obs-exp)/denom;
    };

    function registerTableData(targetId, columns, rows){
      TABLE_CACHE[targetId]={columns,rows};
    }

    function tableFromData(targetId, columns, rows, options={}){
      const root=document.getElementById(targetId);
      if(!root) return;
      if(!rows||!rows.length){
        root.innerHTML='<div class="empty-message">Sem dados disponíveis.</div>';
        registerTableData(targetId, columns, []);
        return;
      }
      const head=columns.map(c=>`<th${c.right?' style="text-align:right"':''}>${c.label||c.key}</th>`).join('');
      const body=rows.map((r,idx)=>{
        return '<tr>'+columns.map(c=>{
          let val=r[c.key];
          if(c.format) val=c.format(val,r,idx);
          return `<td${c.right?' style="text-align:right"':''}>${val??''}</td>`;
        }).join('')+'</tr>';
      }).join('');
      root.innerHTML=`<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
      registerTableData(targetId, columns, rows);
      const trs=root.querySelectorAll('tbody tr');
      trs.forEach((tr,idx)=>{
        if(options.getRowClass){
          const cls=options.getRowClass(rows[idx]);
          if(cls) tr.classList.add(cls);
        }
        if(options.onRowClick){
          tr.style.cursor='pointer';
          tr.addEventListener('click',()=>options.onRowClick(rows[idx]));
        }
      });
    }

    const tryGetSheet = (wb,name)=>{
      if(!wb.SheetNames.includes(name)) return null;
      try{
        return XLSX.utils.sheet_to_json(wb.Sheets[name]);
      }catch(e){
        console.error(`Erro ao ler aba ${name}:`,e);
        return null;
      }
    };

    async function fetchRelativeWorkbook(){
      const url='analise_financeira_v3.xlsx';
      try{
        const res=await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const arr=await res.arrayBuffer();
        return XLSX.read(arr,{type:'array'});
      }catch(e){
        throw new Error(`Não foi possível carregar ${url}. Verifique se o arquivo está na mesma pasta. Erro: ${e.message}`);
      }
    }

    async function loadViaPicker(){
      if(!window.showOpenFilePicker){
        throw new Error('Seu navegador não suporta o seletor de arquivos moderno. Use "Selecionar Arquivo".');
      }
      try{
        const [handle]=await window.showOpenFilePicker({
          multiple:false,
          types:[{
            description:'Planilhas Excel',
            accept:{
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx'],
              'application/vnd.ms-excel':['.xls']
            }
          }]
        });
        const file=await handle.getFile();
        const arr=await file.arrayBuffer();
        return XLSX.read(arr,{type:'array'});
      }catch(e){
        if(e.name==='AbortError') throw new Error('Seleção cancelada pelo usuário.');
        throw new Error(`Erro ao abrir arquivo: ${e.message}`);
      }
    }

    async function loadViaInput(file){
      if(!file) throw new Error('Nenhum arquivo selecionado.');
      try{
        const arr=await file.arrayBuffer();
        return XLSX.read(arr,{type:'array'});
      }catch(e){
        throw new Error(`Erro ao processar arquivo: ${e.message}`);
      }
    }

    function validateWorkbook(wb){
      const missingRequired=REQUIRED_SHEETS.filter(s=>!wb.SheetNames.includes(s));
      const missingOptional=OPTIONAL_SHEETS.filter(s=>!wb.SheetNames.includes(s));
      if(missingRequired.length){
        throw new Error(`Abas obrigatórias não encontradas: ${missingRequired.join(', ')}`);
      }
      return {missingOptional};
    }

    function statusBadge(sheet, hasData){
      document.querySelectorAll(`[data-status-sheet="${sheet}"]`).forEach(el=>{
        el.dataset.hasData = hasData ? 'true' : 'false';
        el.classList.toggle('hidden', !!hasData);
        const card = el.closest('.card');
        if(card){
          const anyMissing = Array.from(card.querySelectorAll('[data-status-sheet]')).some(b=>b.dataset.hasData==='false');
          card.classList.toggle('card-empty', anyMissing);
        }
      });
    }

    function applySearch(rows){
      if(!state.searchTerm) return rows;
      const term=state.searchTerm.toLowerCase();
      return rows.filter(row=>{
        const keys=['regime_base','segmento','cliente'].filter(key=>row[key]!==undefined && row[key]!==null);
        if(!keys.length) return true;
        return keys.some(key=> String(row[key]).toLowerCase().includes(term));
      });
    }

    function renderFilterChip(containerId, value, onClear){
      const container=document.getElementById(containerId);
      if(!container) return;
      container.innerHTML='';
      if(!value) return;
      const div=document.createElement('div');
      div.className='chip';
      div.innerHTML=`Filtro: <strong>${value}</strong> <button type="button" aria-label="Limpar filtro">×</button>`;
      div.querySelector('button').addEventListener('click',onClear);
      container.appendChild(div);
    }

    function renderHero(){
      const g=(state.datasets.ticketGeral||[])[0]||{};
      const totalReceita = asNum(g.receita_mensal) || sumBy(state.datasets.ticketRegime,'receita_mensal') || sumBy(state.datasets.resultadoRegimeComPeso,'receita_mensal');
      const totalClientes = asNum(g.qtd_clientes) || sumBy(state.datasets.ticketRegime,'qtd_clientes') || sumBy(state.datasets.resultadoRegimeComPeso,'qtd_clientes');
      const ticketMedio = totalClientes? totalReceita/totalClientes : asNum(g.ticket_medio_mensal);
      const custoTotalGeral = asNum(g.custo_mensal_total||g.custo_total||0);
      const custoTotal = custoTotalGeral || sumBy(state.datasets.resultadoRegimeComPeso,'custo_mensal') || sumBy(state.datasets.resultadoRegimeSemPeso,'custo_mensal');
      const resultadoTotalSem = sumBy(state.datasets.resultadoRegimeSemPeso,'resultado_mensal');
      const receitaSem = sumBy(state.datasets.resultadoRegimeSemPeso,'receita_mensal');
      const resultadoTotalCom = sumBy(state.datasets.resultadoRegimeComPeso,'resultado_mensal');
      const receitaCom = sumBy(state.datasets.resultadoRegimeComPeso,'receita_mensal');
      const custoMedio = totalClientes? custoTotal/totalClientes : 0;
      const resultadoMedio = totalClientes? resultadoTotalCom/totalClientes : 0;

      document.querySelector('#kpi-receita-mensal .value').textContent = totalReceita? BRL.format(totalReceita) : '—';
      document.querySelector('#kpi-ticket-medio .value').textContent = ticketMedio? BRL.format(ticketMedio) : '—';
      document.querySelector('#kpi-qtd-clientes').textContent = totalClientes? `${INT.format(totalClientes)} clientes` : '— clientes';
      document.querySelector('#kpi-custo-medio .value').textContent = custoMedio? BRL.format(custoMedio) : '—';
      document.querySelector('#kpi-resultado-medio .value').textContent = resultadoMedio? BRL.format(resultadoMedio) : '—';

      const margemSem = receitaSem? resultadoTotalSem/receitaSem : 0;
      const margemCom = receitaCom? resultadoTotalCom/receitaCom : 0;

      const kpiSem=document.getElementById('kpi-resultado-sem-peso');
      kpiSem.querySelector('.value').textContent = BRL.format(resultadoTotalSem);
      const pillSem=document.getElementById('kpi-margem-sem-peso');
      pillSem.textContent=PCT1.format(margemSem);
      pillSem.classList.toggle('positive',margemSem>=0);
      pillSem.classList.toggle('negative',margemSem<0);

      const kpiCom=document.getElementById('kpi-resultado-com-peso');
      kpiCom.querySelector('.value').textContent = BRL.format(resultadoTotalCom);
      const pillCom=document.getElementById('kpi-margem-com-peso');
      pillCom.textContent=PCT1.format(margemCom);
      pillCom.classList.toggle('positive',margemCom>=0);
      pillCom.classList.toggle('negative',margemCom<0);

      const resumo = (state.datasets.resumoRetirada||[])[0]||{};
      document.getElementById('meta-alfa').textContent = resumo.alfa_volume ?? resumo.alfavolume ?? '—';
      document.getElementById('meta-beta').textContent = resumo.beta_ticket ?? resumo.beta ?? '—';
      const adv=asNum(resumo.abatimento_rateio_advocacia_aplicado);
      document.getElementById('meta-adv').textContent = adv? BRL.format(adv) : '—';
    }
    function renderResultadoRegime(){
      const addDerived = row=>{
        const clientes=asNum(row.qtd_clientes);
        return {
          ...row,
          custo_medio_calc: clientes? asNum(row.custo_mensal)/clientes : 0,
          resultado_medio_calc: clientes? asNum(row.resultado_mensal)/clientes : 0,
          margem_calc: asNum(row.receita_mensal)? asNum(row.resultado_mensal)/asNum(row.receita_mensal) : 0
        };
      };

      const semPesoOriginal = (state.datasets.resultadoRegimeSemPeso||[]).map(addDerived);
      const semPeso = applySearch(semPesoOriginal);
      tableFromData('tabRegimeSemPeso',[
        {key:'regime_base',label:'Regime'},
        {key:'qtd_clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
        {key:'ticket_medio_mensal',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'receita_mensal',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo_mensal',label:'Custo Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo_medio_calc',label:'Custo Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'resultado_mensal',label:'Resultado',right:true,format:(v)=>{const val=asNum(v);return (val>=0?'<span class="pill positive">':'<span class="pill negative">')+BRL.format(val)+'</span>';},export:v=>asNum(v)},
        {key:'resultado_medio_calc',label:'Resultado Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'margem_calc',label:'Margem',right:true,format:v=>PCT1.format(v)}
      ], semPeso);

      const comPesoData = (state.datasets.resultadoRegimeComPeso||[]).map(addDerived);
      const comPeso = applySearch(comPesoData);
      tableFromData('tabRegimeComPeso',[
        {key:'regime_base',label:'Regime'},
        {key:'qtd_clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
        {key:'ticket_medio_mensal',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'receita_mensal',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo_mensal',label:'Custo Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo_medio_calc',label:'Custo Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'resultado_mensal',label:'Resultado',right:true,format:(v)=>{const val=asNum(v);return (val>=0?'<span class="pill positive">':'<span class="pill negative">')+BRL.format(val)+'</span>';},export:v=>asNum(v)},
        {key:'resultado_medio_calc',label:'Resultado Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'margem_calc',label:'Margem',right:true,format:v=>PCT1.format(v)}
      ], comPeso, {
        onRowClick:(row)=>{
          state.filters.segmentRegime=row.regime_base||null;
          renderSegmentos();
          renderFilterChip('chip-segmento', state.filters.segmentRegime, ()=>{
            state.filters.segmentRegime=null;
            renderSegmentos();
          });
        },
        getRowClass:(row)=> state.filters.segmentRegime && row.regime_base===state.filters.segmentRegime ? 'row-active' : ''
      });

      statusBadge('Resultado_Regime_Sem_Peso', semPesoOriginal.length>0);
      statusBadge('Resultado_Regime_Com_Peso', comPesoData.length>0);
    }

    function renderSegmentos(){
      const rows = (state.datasets.resultadoSegmentoComPeso||[]).map(row=>({
        ...row,
        custo_medio_calc: asNum(row.qtd_clientes)? asNum(row.custo_mensal_segmento||row.custo_mensal)/asNum(row.qtd_clientes):0,
        resultado_medio_calc: asNum(row.qtd_clientes)? asNum(row.resultado_mensal)/asNum(row.qtd_clientes):0
      }));
      const filtered = rows.filter(row=> !state.filters.segmentRegime || row.regime_base===state.filters.segmentRegime);
      const finalRows = applySearch(filtered);
      tableFromData('tabSegmentoComPeso',[
        {key:'regime_base',label:'Regime'},
        {key:'segmento',label:'Atividade'},
        {key:'qtd_clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
        {key:'receita_mensal_segmento',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo_mensal_segmento',label:'Custo Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'custo_medio_calc',label:'Custo Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'resultado_mensal',label:'Resultado',right:true,format:v=>{const val=asNum(v);return (val>=0?'<span class="pill positive">':'<span class="pill negative">')+BRL.format(val)+'</span>';},export:v=>asNum(v)},
        {key:'resultado_medio_calc',label:'Resultado Médio',right:true,format:v=>BRL.format(asNum(v))}
      ], finalRows);
      statusBadge('Resultado_Segmento_Com_Peso', finalRows.length>0 || (state.datasets.resultadoSegmentoComPeso||[]).length>0);
      renderFilterChip('chip-segmento', state.filters.segmentRegime, ()=>{
        state.filters.segmentRegime=null;
        renderSegmentos();
      });
    }

    function renderTickets(){
      const rowsReg = state.datasets.ticketRegime||[];
      const totalReceita = sumBy(rowsReg,'receita_mensal');
      const totalClientes = sumBy(rowsReg,'qtd_clientes');
      const enriched = rowsReg.map(r=>{
        const receita=asNum(r.receita_mensal);
        const clientes=asNum(r.qtd_clientes);
        const percReceita = totalReceita? receita/totalReceita : 0;
        const percClientes = totalClientes? clientes/totalClientes : 0;
        const indice = percClientes? percReceita/percClientes : 0;
        return {...r, perc_receita:percReceita, perc_clientes:percClientes, indice_concentracao:indice};
      });
      const filteredReg = applySearch(enriched);
      tableFromData('tabTicketsRegime',[
        {key:'regime_base',label:'Regime'},
        {key:'qtd_clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
        {key:'receita_mensal',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'ticket_medio_mensal',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'ticket_mediano_mensal',label:'Ticket Mediano',right:true,format:v=>BRL.format(asNum(v))},
        {key:'perc_receita',label:'% Receita',right:true,format:v=>PCT1.format(asNum(v))},
        {key:'perc_clientes',label:'% Clientes',right:true,format:v=>PCT1.format(asNum(v))},
        {key:'indice_concentracao',label:'Índice Concentração',right:true,format:v=>DEC2.format(asNum(v))}
      ], filteredReg, {
        onRowClick:(row)=>{
          state.filters.ticketRegime=row.regime_base||null;
          renderTicketDetalhes();
          renderFilterChip('chip-tickets', state.filters.ticketRegime, ()=>{
            state.filters.ticketRegime=null;
            renderTicketDetalhes();
          });
        },
        getRowClass:(row)=> state.filters.ticketRegime && row.regime_base===state.filters.ticketRegime ? 'row-active' : ''
      });
      statusBadge('Ticket_Regime', (state.datasets.ticketRegime||[]).length>0);
      renderTicketDetalhes();
      renderFilterChip('chip-tickets', state.filters.ticketRegime, ()=>{
        state.filters.ticketRegime=null;
        renderTicketDetalhes();
      });
    }

    function renderTicketDetalhes(){
      const filterByRegime = row=> !state.filters.ticketRegime || row.regime_base===state.filters.ticketRegime;
      const regAtiv = applySearch((state.datasets.ticketRegimeAtividade||[]).filter(filterByRegime));
      tableFromData('tabTicketsRegAtiv',[
        {key:'regime_base',label:'Regime'},
        {key:'segmento',label:'Atividade'},
        {key:'qtd_clientes',label:'Clientes',right:true,format:v=>INT.format(asNum(v))},
        {key:'receita_mensal',label:'Receita Mensal',right:true,format:v=>BRL.format(asNum(v))},
        {key:'ticket_medio_mensal',label:'Ticket Médio',right:true,format:v=>BRL.format(asNum(v))},
        {key:'ticket_mediano_mensal',label:'Ticket Mediano',right:true,format:v=>BRL.format(asNum(v))}
      ], regAtiv);

      const clientesRows = (state.datasets.ticketClientes||[]).filter(filterByRegime);
      const finalClientes = applySearch(clientesRows).slice(0, state.filters.ticketRegime ? clientesRows.length : 25);
      tableFromData('tabTicketsClientes',[
        {key:'rank',label:'#',right:true,format:v=>INT.format(asNum(v))},
        {key:'cliente',label:'Cliente'},
        {key:'regime_base',label:'Regime'},
        {key:'segmento',label:'Atividade'},
        {key:'ticket_mensal',label:'Ticket Mensal',right:true,format:v=>BRL.format(asNum(v))}
      ], finalClientes);
    }

    function renderTopDespesas(){
      const top = applySearch(state.datasets.topDespesas||[]);
      tableFromData('tabTopDespesas',[
        {key:'rank',label:'#',right:true,format:v=>INT.format(asNum(v))},
        {key:'grupo',label:'Grupo'},
        {key:'item_nome',label:'Item'},
        {key:'valor',label:'Valor',right:true,format:v=>BRL.format(asNum(v))},
        {key:'perc_total_despesas',label:'% do Total',right:true,format:v=>PCT1.format(asNum(v))}
      ], top);
      statusBadge('Top_Despesas', (state.datasets.topDespesas||[]).length>0);

      const adm = state.datasets.topDespesasAdm||[];
      const admFiltered = applySearch(adm);
      tableFromData('tabTopDespesasAdm',[
        {key:'rank',label:'#',right:true,format:v=>INT.format(asNum(v))},
        {key:'item_nome',label:'Item (ADM)'},
        {key:'valor',label:'Valor',right:true,format:v=>BRL.format(asNum(v))},
        {key:'perc_no_grupo',label:'% no Grupo',right:true,format:(v,row)=>{
          const width=Math.min(100,Math.abs(asNum(v))*100);
          return `<div class="bar-cell"><span>${PCT1.format(asNum(v))}</span><div class="bar-wrapper"><div class="bar" style="width:${width}%"></div></div></div>`;
        },export:v=>asNum(v)}
      ], admFiltered);
      statusBadge('Top_Despesas_Adm', (state.datasets.topDespesasAdm||[]).length>0);
    }

    function renderResumo(){
      const resumo = applySearch(state.datasets.resumoRetirada||[]);
      const sampleKeys = Object.keys((resumo[0]||{}));
      const columns = sampleKeys.map(k=>{
        const label = k.replace(/_/g,' ');
        const lower = k.toLowerCase();
        let format;
        if(/perc|percent|%/.test(lower)){
          format=v=>PCT1.format(asNum(v));
        }else if(/receita|resultado|custo|valor|abatimento|retirada|prolabore|advocacia/.test(lower)){
          format=v=>BRL.format(asNum(v));
        }else if(/qtd|quantidade|clientes/.test(lower)){
          format=v=>INT.format(asNum(v));
        }
        return {key:k,label,right:!!format,format};
      });
      tableFromData('tabResumoRetirada', columns, resumo);
      statusBadge('Resumo_Retirada', (state.datasets.resumoRetirada||[]).length>0);
    }

    function renderComparativo(){
      const semPeso = state.datasets.resultadoRegimeSemPeso||[];
      const comPeso = state.datasets.resultadoRegimeComPeso||[];
      const bySem = new Map(semPeso.map(r=>[String(r.regime_base||'').toLowerCase(),r]));
      const rows = comPeso.map(r=>{
        const key=String(r.regime_base||'').toLowerCase();
        const a=bySem.get(key)||{};
        const receitaSem=asNum(a.receita_mensal);
        const receitaCom=asNum(r.receita_mensal);
        const resultadoSem=asNum(a.resultado_mensal);
        const resultadoCom=asNum(r.resultado_mensal);
        const margemSem = receitaSem? resultadoSem/receitaSem : 0;
        const margemCom = receitaCom? resultadoCom/receitaCom : 0;
        const delta = resultadoCom-resultadoSem;
        const deltaMargem = margemCom-margemSem;
        return {
          regime_base:r.regime_base,
          receita_sem_peso:receitaSem,
          receita_com_peso:receitaCom,
          resultado_sem_peso:resultadoSem,
          resultado_com_peso:resultadoCom,
          delta,
          margem_sem:margemSem,
          margem_com:margemCom,
          delta_margem:deltaMargem
        };
      }).sort((a,b)=>Math.abs(b.delta)-Math.abs(a.delta));

      const formatted = applySearch(rows);
      tableFromData('tabComparativo',[
        {key:'regime_base',label:'Regime'},
        {key:'resultado_sem_peso',label:'Resultado (Sem Peso)',right:true,format:v=>BRL.format(asNum(v))},
        {key:'resultado_com_peso',label:'Resultado (Com Peso)',right:true,format:v=>BRL.format(asNum(v))},
        {key:'delta',label:'Impacto (Δ)',right:true,format:v=>{const val=asNum(v);return (val>=0?'<span class="pill positive">':'<span class="pill negative">')+BRL.format(val)+'</span>';},export:v=>asNum(v)},
        {key:'margem_sem',label:'Margem Sem Peso',right:true,format:v=>PCT1.format(asNum(v))},
        {key:'margem_com',label:'Margem Com Peso',right:true,format:v=>PCT1.format(asNum(v))},
        {key:'delta_margem',label:'Δ Margem (p.p.)',right:true,format:v=>{
          const val=asNum(v)*100;
          const label=`${val>=0?'+':'-'}${DEC2.format(Math.abs(val))} p.p.`;
          const cls=asNum(v)>=0?'pill positive':'pill negative';
          return `<span class="${cls}">${label}</span>`;
        },export:v=>asNum(v)*100}
      ], formatted);
    }

    function renderValidations(){
      const list=document.getElementById('validations-list');
      const checks=[];
      const ticketReg=state.datasets.ticketRegime||[];
      ticketReg.forEach(row=>{
        const receita=asNum(row.receita_mensal);
        const reconstruida=asNum(row.ticket_medio_mensal)*asNum(row.qtd_clientes);
        const diff=percentDiff(receita,reconstruida);
        const abs=Math.abs(diff);
        let status='ok';
        if(abs>0.03) status='error';
        else if(abs>0.01) status='warn';
        checks.push({
          status,
          title:`Ticket × Receita — ${row.regime_base||'Regime'}`,
          diff,
          detail:`Receita informada: ${BRL.format(receita)} | Receita reconstruída: ${BRL.format(reconstruida)} | Desvio: ${PCT1.format(diff)}`
        });
      });

      if(ticketReg.length){
        const somaReg= sumBy(ticketReg,'receita_mensal');
        const ticketGeral = (state.datasets.ticketGeral||[])[0]||{};
        const geral=asNum(ticketGeral.receita_mensal);
        const diff=percentDiff(geral,somaReg);
        let status='ok';
        if(Math.abs(diff)>0.03) status='error';
        else if(Math.abs(diff)>0.01) status='warn';
        checks.push({
          status,
          title:'Receita Total Ticket Regime × Ticket Geral',
          diff,
          detail:`Ticket Geral: ${BRL.format(geral)} | Soma Regimes: ${BRL.format(somaReg)} | Desvio: ${PCT1.format(diff)}`
        });
      }

      const resultadoSem = sumBy(state.datasets.resultadoRegimeSemPeso,'resultado_mensal');
      const resultadoCom = sumBy(state.datasets.resultadoRegimeComPeso,'resultado_mensal');
      const diffSem = percentDiff(resultadoSem, resultadoSem);
      checks.push({
        status:'ok',
        title:'Somatório Resultado Sem Peso',
        diff:diffSem,
        detail:`Total consolidado: ${BRL.format(resultadoSem)}`
      });
      const diffCom = percentDiff(resultadoCom, resultadoCom);
      checks.push({
        status:'ok',
        title:'Somatório Resultado Com Peso',
        diff:diffCom,
        detail:`Total consolidado: ${BRL.format(resultadoCom)}`
      });

      if((state.datasets.resultadoSegmentoComPeso||[]).length){
        const segmentos = groupBy(state.datasets.resultadoSegmentoComPeso,'regime_base');
        const divergencias=[];
        (state.datasets.resultadoRegimeComPeso||[]).forEach(row=>{
          const somaSeg = sumBy(segmentos.get(row.regime_base)||[],'resultado_mensal');
          const diff=percentDiff(asNum(row.resultado_mensal), somaSeg);
          if(Math.abs(diff)>0.01){
            divergencias.push(`${row.regime_base||'Regime'} → ${PCT1.format(diff)} (Regime: ${BRL.format(asNum(row.resultado_mensal))} | Segmentos: ${BRL.format(somaSeg)})`);
          }
        });
        checks.push({
          status:divergencias.length?'warn':'ok',
          title:'Segmento (Regime + Atividade) × Regime Com Peso',
          diff:0,
          detail:divergencias.length?divergencias.join('\n'):'Sem divergências relevantes (≤1%)'
        });
      }

      const resumo = (state.datasets.resumoRetirada||[])[0];
      if(resumo){
        const abatimento=asNum(resumo.abatimento_rateio_advocacia_aplicado);
        const adm=state.datasets.topDespesasAdm||[];
        const advocaciaItens=adm.filter(r=> String(r.item_nome||'').toLowerCase().includes('advocacia'));
        const totalAdv=advocaciaItens.reduce((acc,r)=>acc+asNum(r.valor),0);
        let status='warn';
        let mensagem='Não há itens identificados como advocacia para confrontar.';
        if(abatimento===0){
          status='warn';
          mensagem='Nenhum abatimento informado no resumo.';
        }else if(Math.abs(totalAdv-abatimento)<=Math.abs(abatimento)*0.05){
          status='ok';
          mensagem=`Abatimento aplicado: ${BRL.format(abatimento)} | Itens advocacia: ${BRL.format(totalAdv)}`;
        }else{
          status='error';
          mensagem=`Diferença entre abatimento (${BRL.format(abatimento)}) e itens advocacia (${BRL.format(totalAdv)}).`;
        }
        checks.push({
          status,
          title:'Abatimento da Advocacia em ADM',
          diff: abatimento ? percentDiff(abatimento,totalAdv) : 0,
          detail:mensagem
        });
      }

      list.innerHTML='';
      if(!checks.length){
        list.innerHTML='<div class="empty-message">Sem validações disponíveis.</div>';
        return;
      }

      checks.forEach((check,idx)=>{
        const row=document.createElement('div');
        row.className=`validation-row ${check.status}`;
        const icon = check.status==='ok'?'✅':(check.status==='warn'?'⚠️':'❌');
        const badgeClass = check.status==='ok'?'badge ok':(check.status==='warn'?'badge warn':'badge error');
        const diffLabel = `${check.diff>=0?'+':''}${PCT1.format(check.diff||0)}`;
        row.innerHTML=`<div class="header"><div class="header-left">${icon} ${check.title}</div><span class="${badgeClass}">${diffLabel}</span></div>`;
        const details=document.createElement('details');
        const summary=document.createElement('summary');
        summary.textContent='ver cálculo';
        const pre=document.createElement('div');
        pre.textContent=check.detail;
        details.appendChild(summary);
        details.appendChild(pre);
        row.appendChild(details);
        list.appendChild(row);
      });
    }

    function renderAll(){
      renderHero();
      renderResultadoRegime();
      renderSegmentos();
      renderTickets();
      renderTopDespesas();
      renderResumo();
      renderComparativo();
      renderValidations();
    }

    function exportCsv(targetId){
      const table=TABLE_CACHE[targetId];
      if(!table||!table.rows||!table.rows.length){
        showToast('Sem dados para exportar.', 'error');
        return;
      }
      const {columns,rows}=table;
      const header=columns.map(c=>`"${(c.label||c.key||'').replace(/"/g,'""')}"`).join(';');
      const lines=rows.map(row=>columns.map(c=>{
        const raw = c.export ? c.export(row[c.key], row) : row[c.key];
        if(raw===null||raw===undefined) return '';
        if(typeof raw==='number') return raw;
        return `"${String(raw).replace(/"/g,'""')}"`;
      }).join(';'));
      const csv=[header,...lines].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`${targetId}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),5000);
      showToast('Exportação gerada com sucesso!','success');
    }

    function renderDashboard(wb){
      try{
        const sheetStatus=validateWorkbook(wb);
        state.wb=wb;
        state.sheetStatus=sheetStatus;
        state.filters={segmentRegime:null,ticketRegime:null};
        state.searchTerm='';
        const aliasCommon={
          receita_mensal:['receita_mensal_total','receita_mensal_regime','receita_total'],
          ticket_medio_mensal:['ticket_mensal','ticket_medio','ticket_medio_total'],
          ticket_mediano_mensal:['ticket_mediano','ticket_mediano_mensal'],
          qtd_clientes:['qtd_cliente','clientes','qtde_clientes','qtd_clientes_total'],
          custo_mensal:['custo_total','custo_mensal_total'],
          resultado_mensal:['resultado_total','resultado_liquido','resultado_mensal_total'],
          receita_mensal_segmento:['receita_segmento','receita_mensal'],
          custo_mensal_segmento:['custo_segmento','custo_mensal'],
          ticket_medio:['ticket_medio_mensal'],
          resultado:['resultado_mensal']
        };

        const getData=(name, extraAlias={})=>{
          const raw=tryGetSheet(wb,name);
          const data=normalizeRows(raw||[],{...aliasCommon,...extraAlias});
          statusBadge(name, data.length>0);
          return data;
        };

        state.datasets={
          ticketGeral:getData('Ticket_Geral'),
          ticketRegime:getData('Ticket_Regime'),
          ticketRegimeAtividade:getData('Ticket_Regime_Atividade'),
          ticketClientes:getData('Ticket_Clientes'),
          resultadoRegimeSemPeso:getData('Resultado_Regime_Sem_Peso'),
          resultadoRegimeComPeso:getData('Resultado_Regime_Com_Peso'),
          resultadoSegmentoComPeso:getData('Resultado_Segmento_Com_Peso'),
          topDespesas:getData('Top_Despesas'),
          topDespesasAdm:getData('Top_Despesas_Adm'),
          resumoRetirada:getData('Resumo_Retirada')
        };

        document.querySelector('.subtitle').textContent = `✅ Planilha carregada com sucesso - ${wb.SheetNames.length} abas`;
        if(sheetStatus.missingOptional.length){
          showStatus(`⚠️ Abas opcionais ausentes: ${sheetStatus.missingOptional.join(', ')}`, 'info');
        }else{
          showStatus('✅ Dashboard renderizado com sucesso!', 'success');
        }

        const searchInput=document.getElementById('global-search');
        if(searchInput && !searchInput.dataset.bound){
          searchInput.dataset.bound='true';
          searchInput.addEventListener('input',e=>{
            state.searchTerm=e.target.value.trim();
            renderAll();
          });
        }
        if(searchInput){
          searchInput.value='';
        }

        document.querySelectorAll('.tab').forEach(btn=>{
          if(btn.dataset.bound) return;
          btn.dataset.bound='true';
          btn.addEventListener('click',()=>{
            const tab=btn.getAttribute('data-tab');
            btn.parentElement.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const card=btn.closest('.card');
            card.querySelectorAll('[id^="tab"]').forEach(el=>el.classList.add('hidden'));
            const target=card.querySelector('#'+tab);
            if(target) target.classList.remove('hidden');
          });
        });

        document.querySelectorAll('[data-export]').forEach(btn=>{
          if(btn.dataset.bound) return;
          btn.dataset.bound='true';
          btn.addEventListener('click',()=>exportCsv(btn.getAttribute('data-export')));
        });

        document.querySelectorAll('[data-excel]').forEach(btn=>{
          if(btn.dataset.bound) return;
          btn.dataset.bound='true';
          btn.addEventListener('click',()=>{
            const sheet=btn.getAttribute('data-excel');
            showToast(`Abra a aba "${sheet}" na planilha para consultar o detalhamento.`, 'info');
          });
        });

        renderAll();
        showToast('Relatório carregado com sucesso!', 'success');
      }catch(e){
        console.error('Erro ao renderizar:', e);
        showStatus(`❌ Erro ao processar dados: ${e.message}`, 'error');
        showToast(e.message, 'error');
      }
    }
    function testWorkbook(wb) {
      let report = '<div class="diagnostic">';
      report += `<strong>✅ Planilha carregada com sucesso!</strong><br><br>`;
      report += `<strong>Abas encontradas (${wb.SheetNames.length}):</strong><br>`;

      const expectedSheets = REQUIRED_SHEETS.concat(OPTIONAL_SHEETS);

      expectedSheets.forEach(name => {
        const exists = wb.SheetNames.includes(name);
        const icon = exists ? '✅' : '❌';
        report += `${icon} ${name}`;
        if (exists) {
          const data = tryGetSheet(wb, name);
          report += ` (${data ? data.length : 0} linhas)`;
        }
        report += '<br>';
      });

      const outros = wb.SheetNames.filter(s => !expectedSheets.includes(s));
      if(outros.length){
        report += '<br><strong>Outras abas:</strong><br>';
        outros.forEach(s => {
          const data = tryGetSheet(wb, s);
          report += `ℹ️ ${s} (${data ? data.length : 0} linhas)<br>`;
        });
      }

      report += '</div>';
      showStatus(report, 'info');
    }

    async function boot(method='auto'){
      showLoading(true);
      showStatus('⏳ Carregando planilha...', 'info');

      try{
        let wb;

        if(method==='auto'){
          try{
            wb=await fetchRelativeWorkbook();
            showToast('Planilha carregada automaticamente', 'success');
          }catch(e1){
            console.warn('Fetch automático falhou:', e1.message);
            throw new Error('Não foi possível carregar automaticamente. Use um dos botões para selecionar o arquivo manualmente.');
          }
        }else if(method==='picker'){
          wb=await loadViaPicker();
          showToast('Planilha carregada via seletor', 'success');
        }

        if(wb){
          renderDashboard(wb);
        }
      }catch(e){
        console.error('Erro no boot:', e);
        showStatus(`❌ ${e.message}<br><br>📌 <strong>Como resolver:</strong><br>
          1. Certifique-se que o arquivo <code>analise_financeira_v3.xlsx</code> está na mesma pasta que este HTML<br>
          2. Use o botão "📁 Selecionar Arquivo" para escolher o arquivo manualmente<br>
          3. Ou use "📂 Seletor do Sistema" (se seu navegador suportar)`, 'error');
        showToast(e.message, 'error');
      }finally{
        showLoading(false);
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', async ()=>{
      await boot('auto');
    });

    document.getElementById('btn-picker').addEventListener('click', async ()=>{
      showLoading(true);
      try{
        const wb=await loadViaPicker();
        renderDashboard(wb);
      }catch(e){
        showToast(e.message, 'error');
        showStatus(`❌ ${e.message}`, 'error');
      }finally{
        showLoading(false);
      }
    });

    document.getElementById('file-input').addEventListener('change', async (e)=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      showLoading(true);
      try{
        const wb=await loadViaInput(f);
        renderDashboard(wb);
        showToast(`Arquivo ${f.name} carregado com sucesso!`, 'success');
      }catch(e){
        showToast(e.message, 'error');
        showStatus(`❌ ${e.message}`, 'error');
      }finally{
        showLoading(false);
      }
    });

    document.getElementById('btn-test').addEventListener('click', async ()=>{
      showLoading(true);
      try{
        let wb;
        try{
          wb=await fetchRelativeWorkbook();
        }catch(e){
          wb=await loadViaPicker();
        }
        testWorkbook(wb);
        showToast('Teste concluído! Veja os detalhes acima.', 'info');
      }catch(e){
        showToast(e.message, 'error');
        showStatus(`❌ ${e.message}`, 'error');
      }finally{
        showLoading(false);
      }
    });

    boot('auto');
  </script>
</body>
</html>
